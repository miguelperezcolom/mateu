/**
 * Copyright (c) 2017, Oracle and/or its affiliates.
 * All rights reserved.
 */

define(["./persistenceManager","./persistenceStoreManager","./persistenceUtils","./impl/logger","./impl/sql-where-parser.min"],(function(e,r,n,t,a){"use strict";function o(a,o,i,l,s,u,c){return e.getCache()._internalMatch(a,{ignoreSearch:!0,ignoreBody:!0}).then((function(l){if(l)return"unknown"===l.resourceType?null:"single"===l.resourceType?e.getCache()._matchByKey(a,l.key):r.openStore(o).then((function(e){return e.find(i)})).then((function(r){var i=!1,f=r.length;u&&u>0&&(r=u<f?r.slice(u):[]),c&&c>0&&r.length>0&&c<r.length&&(i=!0,r=r.slice(0,c));var h={name:o,data:r,resourceType:"collection"};return e.getCache()._matchByKey(a,l.key,{ignoreBody:!0}).then((function(e){return s([h],e).then((function(r){return r.clone().text().then((function(a){if(!(null!=a&&a.length>0))return r;try{var o=JSON.parse(a);return null!=o.items?(c&&(o.limit=parseInt(c,10)),u&&(o.offset=parseInt(u,10)),o.hasMore=i,o.totalResults=f,n.setResponsePayload(e,o)):r}catch(e){t.log("JSON parse error on payload: "+a)}}))}))}))}));var f=function(e){var r=e.url.split("/");return r.length>1?r[r.length-1].split("?")[0]:null}(a);return f?r.openStore(o).then((function(e){return e.findByKey(f)})).then((function(r){if(r){var t=function(e){var r=e.url.split("/");return r.length>1?(r.pop(),r.join("/")):null}(a);return t?n.requestToJSON(a).then((function(a){return a.url=t,n.requestFromJSON(a).then((function(n){return e.getCache().match(n,{ignoreSearch:!0,ignoreBody:!0}).then((function(e){if(e)return s([{name:o,data:[r],resourceType:"single"}],e)}))}))})):void 0}})):void 0}))}function i(e){var r=[];if(null!=e){"?"===e.charAt(0)&&(e=e.slice(1));var n,t,a,o=(e=e||"").split("&");r=o.map((function(e){return(a=e.indexOf("="))>-1?(n=e.slice(0,a),t=l(t=e.slice(a+1))):(n=e,t=""),[n=l(n),t]}))}return{next:function(){var e=r.shift();return{done:void 0===e,value:e}}}}function l(e){return decodeURIComponent(e.replace(/\+/g," "))}return{getSimpleQueryHandler:function(e,r,a){var l=function(e){var r,n=e.split("?");return n.length>1&&(r=n[1]),{offset:0,limit:-1,searchCriteria:r}},s=function(s,u){if("GET"==s.method||"HEAD"==s.method){t.log("Offline Persistence Toolkit queryHandlers: SimpleQueryHandler processing request");var c,f,h=l(s.url),d=n._mapFindQuery(function(e,r){var n={};if(e){var t,a,o,l,s={};t="undefined"==typeof URLSearchParams?i(e):new URLSearchParams(e).entries();do{null!=(a=t.next()).value&&(o=a.value[0],l=a.value[1],r&&-1!=r.indexOf(o)||(s["value."+o]=l))}while(!a.done);Object.keys(s).length>0&&(n.selector=s)}return n}(h.searchCriteria,r),a);if(null!=u.jsonProcessor&&(c=u.jsonProcessor.shredder,f=u.jsonProcessor.unshredder),null!=c&&null!=f)return o(s,e,d,0,f)}return Promise.resolve()};return s.normalizeQueryParameter=l,s},getOracleRestQueryHandler:function(e,r,l){var s;r=r||function(e){return function(e){var r={};if(e){var n=a.defaultConfig;n.operators[5]["<>"]=2,n.tokenizer.shouldTokenize.push("<>");var t,o=new a(n),i=e.split(";"),l={},s=[],u={};for(t=0;t<i.length;t++)u=o.parse(i[t],(function(e,r){"AND"!=(e=e.toUpperCase())&&"OR"!=e&&","!=e&&(r[0]="value."+r[0]);var n=r[0],t=r[1],a={};switch(e){case">":a[n]={$gt:t};break;case"<":a[n]={$lt:t};break;case">=":a[n]={$gte:t};break;case"<=":a[n]={$lte:t};break;case"=":a[n]={$eq:t};break;case"!=":case"<>":a[n]={$ne:t};break;case"AND":a={$and:r};break;case"OR":a={$or:r};break;case"LIKE":t=t.replace(/%/g,".*"),a[n]={$regex:RegExp(t,"i")};break;case"BETWEEN":var o=[];o[0]={},o[1]={},o[0][n]={$gte:r[1]},o[1][n]={$lte:r[2]},a={$and:o};break;case"IS":if(null===t){var i=[];i[0]={},i[1]={},i[0][n]={$eq:null},i[1][n]={$eq:void 0},a={$or:i}}break;case"IN":a[n]={$in:[].concat(t)};break;case",":return[t].concat(n)}return a})),s.push(u);s.length>1?l.$and=s:1==s.length&&(l=s[0]),Object.keys(l).length>0&&(r.selector=l)}return r}(e)};var u=function(e){var r,n,t,a,o,l=-1,u=0,c=e.split("?");s=[],n="undefined"==typeof URLSearchParams?i(c[1]):new URLSearchParams(c[1]).entries();do{null!=(t=n.next()).value&&(a=t.value[0],o=t.value[1],"q"==a?r=o:"limit"==a?l=parseInt(o,10):"offset"==a?u=parseInt(o,10):"orderby"!==a.toLowerCase()||s.length||o.split(",").forEach((function(e){var r=e.split(":"),n={};n["value."+r[0]]=r[1]?r[1]:"asc",s.push(n)})))}while(!t.done);return{offset:u,limit:l,searchCriteria:r}},c=function(a,i){if("GET"==a.method||"HEAD"==a.method){t.log("Offline Persistence Toolkit queryHandlers: OracleRestQueryHandler processing request");var c,f,h=u(a.url),d=n._mapFindQuery(r(h.searchCriteria),l,s);if(null!=i.jsonProcessor&&(c=i.jsonProcessor.shredder,f=i.jsonProcessor.unshredder),null!=c&&null!=f)return o(a,e,d,0,f,h.offset,h.limit).then((function(e){if(e)return e.clone().text().then((function(r){if(null!=r&&r.length>0)try{var t=JSON.parse(r);return t.links?e:(t.links=[{rel:"self",href:a.url}],n.setResponsePayload(e,t).then((function(e){return e})))}catch(e){}}))}))}return Promise.resolve()};return c.normalizeQueryParameter=u,c}}}));