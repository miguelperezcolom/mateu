/**
 * Copyright (c) 2017, Oracle and/or its affiliates.
 * All rights reserved.
 */

define(["./persistenceManager","./persistenceUtils","./impl/defaultCacheHandler","./impl/logger"],(function(e,n,t,r){"use strict";function s(n,t,s){return new Promise((function(i,l){r.log("Offline Persistence Toolkit fetchStrategies: Process queryParams for Request"),function(e,n){var t=function(e){var n=null;return null!=e.queryHandler&&(n=e.queryHandler),n}(n);return null==t?Promise.resolve():t(e,n)}(n,t).then((function(t){t?(i(t.clone()),o(n,s)):(r.log("Offline Persistence Toolkit fetchStrategies: Response for queryParams is not null"),function(n){return e.getCache().match(n)}(n).then((function(t){t?(r.log("Offline Persistence Toolkit fetchStrategies: Cached Response is not null"),i(t),o(n,s)):(r.log("Offline Persistence Toolkit fetchStrategies: Cached Response is null"),e.browserFetch(n).then((function(e){var t=e.clone();i(t),s&&s(n,e)}),(function(e){i(new Response(null,{status:503,statusText:"No cached response exists"}))})))})))}))}))}function o(t,s){s&&(r.log("Offline Persistence Toolkit fetchStrategies: Fetch for ServerResponseCallback"),e.browserFetch(t).then((function(e){n._cloneResponse(e,{url:t.url}).then((function(e){s(t,e)}))})))}return{getCacheFirstStrategy:function(o){var i=(o=o||{}).serverResponseCallback,l="disabled"==o.backgroundFetch;return l&&(i=null),i||l||(i=function(e,n){return Promise.resolve(n)}),function(o,l){if(r.log("Offline Persistence Toolkit fetchStrategies: Processing CacheFirstStrategy"),i)var c=function(r,s){var o=n.buildEndpointKey(r);t.registerEndpointOptions(o,l);var c={};return n._cloneResponse(s,{url:r.url}).then((function(e){return i(r,e)})).then((function(n){return c.resolvedResponse=n,e.getCache().hasMatch(r)})).then((function(t){var s=c.resolvedResponse.clone();return t?null==c.resolvedResponse||n.isCachedResponse(c.resolvedResponse)||"GET"!=r.method&&"HEAD"!=r.method?s:e.getCache().put(r,c.resolvedResponse).then((function(){return s})):s})).finally((function(){t.unregisterEndpointOptions(o)}))};return s(o,l,c)}},getCacheIfOfflineStrategy:function(){return function(t,o){return r.log("Offline Persistence Toolkit fetchStrategies: Processing CacheIfOfflineStrategy"),e.isOnline()?e.browserFetch(t).then((function(e){return e.ok?n._cloneResponse(e,{url:t.url}):function(e,n,t){return n.status<500?(r.log("Offline Persistence Toolkit fetchStrategies: Response is not ok"),Promise.resolve(n)):s(e,t)}(t,e,o)}),(function(e){return r.log(e),s(t,o)})):s(t,o)}}}}));