/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","preact/jsx-runtime","preact","ojs/ojcore-base","ojs/ojcustomelement-utils","ojs/ojcustomelement-registry","ojs/ojmetadatautils","ojs/ojlogger"],function(e,t,o,r,s,n,i,a){"use strict";r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r;const c=Symbol("row");class d{static renderNodes(e,r,n,i){const a=n.parentStub;let l=()=>Array.from(a.childNodes);n.nodes&&(l=d._getRetrieveNodesFunction(n.nodes));const p=console.error;console.error=(e,t)=>{-1===e.indexOf("Improper nesting of table.")&&p.apply(console,arguments)};try{const e=i?Array.from(i).reduce((e,[o,r])=>t.jsx(o.Provider,{value:r,children:e}),r):r;o.render(e,a)}finally{console.error=p}let u=!0;const m=l();m.forEach(e=>{e.setAttribute?(e.setAttribute("data-oj-vdom-template-root",""),u=!1):e._oj_vdom_template_root=!0,e[c]=n,e[s.CACHED_BINDING_PROVIDER]="preact"}),n.vnode=r,n.nodes=m,u&&e.setAttribute("data-oj-vdom-template-text-roots","")}static clean(e){const t=e[c];if(t&&!t.cleaned){t.cleaned=!0;const r=d._getInsertNodesFunction(t.nodes);o.render(null,t.parentStub),r(t.nodes),t.computedVNode?.dispose();const s=t.template,n=s._cachedRows.indexOf(t);s._cachedRows.splice(n,1),e[c]=null}}static findTemplateRoots(e,t){let o=e&&e.querySelectorAll?Array.from(e.querySelectorAll('[data-oj-vdom-template-root=""]')):[];e&&e.hasAttribute&&e.hasAttribute("data-oj-vdom-template-root")&&o.push(e);let r=t?.hasAttribute?.("data-oj-vdom-template-text-roots");if(!r){r=(e&&e.querySelectorAll?e.querySelectorAll('[data-oj-vdom-template-text-roots=""]'):[]).length>0}if(r){const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);let r=t.currentNode;for(;r;)r._oj_vdom_template_root&&o.push(r),r=t.nextNode()}return o}static _getInsertNodesFunction(e){const t=e[e.length-1],o=t.parentNode,r=t.nextSibling;return e=>{e.forEach(e=>o.insertBefore(e,r))}}static _getRetrieveNodesFunction(e){const t=e[0],o=e[e.length-1],r=t.parentNode,s=t.previousSibling,n=o.nextSibling;return()=>{const e=[];for(let t=s?s.nextSibling:r.firstChild;t!==n;t=t.nextSibling)e.push(t);return e}}static resolveVDomTemplateProps(e,t,o,r,s,i,a){const c=n.getPropertiesForElementTag(o),[p,u]=d.extendTemplate(e,d._COMPUTED_PROPS_CACHE_FACTORY,e=>{for(const t of p)t.recalculateValue(e)}),m=new l(e=>d._computeProps(e,o,c,r,s,a),t,i,u);return p.add(m),m}static _computeProps(e,t,o,r,n,a){const c=e(n),d=(Array.isArray(c)?c:[c]).find(e=>e.type===t);if(!d)throw new Error("Item template must contain an element named {elementTagName}");const l={},p=d.props;return Object.keys(p).forEach(e=>{const{prop:t,value:n}=s.convertPrivatePropFromPreact(e,d.props[e]);r.has(t)&&(l[t]=s.transformPreactValue(null,t,i.getPropertyMetadata(t,o),n))}),l}static extendTemplate(e,t,o){if(!e._cachedRows){let r=e.render;Object.defineProperties(e,{_cachedRows:{writable:!0,value:t()},render:{enumerable:!0,get:()=>r,set(e){r=e,e&&o(e)}}})}return e._cachedRows}}d._COMPUTED_PROPS_CACHE_FACTORY=()=>{const e=new Set;return[e,e.delete.bind(e)]},d._ROW_CACHE_FACTORY=()=>[];class l{constructor(e,t,o,r){this._calculate=e,this._defaultProps=o,this._disposeCallback=r,this._value=e(t),this._merged=this._getMergedValue(this._value)}peek(){return this._merged}subscribe(e){if(this._sub)throw new Error("Resolved property observable does not support multiple subscribers");this._sub=e}dispose(){this._disposeCallback(this)}recalculateValue(e){const t=this._calculate(e),o=this._value;this._value=t,this._sub&&!r.Object.compareValues(t,o)&&(this._merged=this._getMergedValue(t),this._sub(this._merged))}_getMergedValue(e){return Object.assign({},this._defaultProps,e)}}class p{static getContext(e,t,o,r,s,n,i){if(e){let c=o.__ojBindingContext?o.__ojBindingContext:e.__ContextFor(o);c||(a.info("Binding context not found when processing template for element with id: "+t.id+". Using binding context for element instead."),c=e.__ContextFor(t));const d=e.__ExtendBindingContext(c,r,s,n,t);if(d.$provided&&i){const e=new Map([...d.$provided,...i]);d.$provided=e}else i&&(d.$provided=i);return d}const c={$current:r};return n&&(c[n]=r),c}static getResolvedDefaultProps(e,t,o){let r=e.get(t);if(!r){const s=document.createElement(t);r=p.getStaticPropertyMap(s,o,document.body),e.set(t,r)}return r}static getStaticPropertyMap(e,t,o){const r={};if(e){const s=e.style;s.display="none",s.position="absolute",e.setAttribute("data-oj-binding-provider","none"),o.appendChild(e),t.forEach(function(t){void 0!==e[t]&&(r[t]=e[t])}),o.removeChild(e)}return r}static createPropertyBackedByObservable(e,t,o,r,s){const n=e.__Observable(r);Object.defineProperty(t,o,{get:()=>n(),set:e=>{n(e),s&&s(e)},enumerable:!0})}static _storeBindIfChildNodes(e,t){const o="savedNodesId"+s.ElementUtils.getUniqueId(null),r=[];for(;t.childNodes.length>0;){var n=t.childNodes[0];r.push(document.importNode(n,!0)),t.removeChild(n)}return e.set(o,r),o}static _processOjBindIf(e,t,o){const r=`ko _ojBindIf_V2_:{ test:${s.KoBindingUtils.getExpressionForAttr(t,"test",!1)}, nodes:$current._ojNodesMap.${p._storeBindIfChildNodes(e,t)}, ojDoNotUseProcessed:true }`;p._replaceBindElementWithComments(t,o,r)}static _processOjIf(e,t){const o=p._storeBindIfChildNodes(e,t);t.setAttribute("oj-private-do-not-use",`$current._ojNodesMap.${o}`)}static _processOjBindText(e,t,o){const r=`ko text:${s.KoBindingUtils.getExpressionForAttr(t,"value",!0)}`;p._replaceBindElementWithComments(t,o,r)}static _processOjBindForEach(e,t,o){const r=s.KoBindingUtils.createBindForEachHandlerStr(t);r&&p._replaceBindElementWithComments(t,o,r)}static _replaceBindElementWithComments(e,t,o){const r=document.createComment(s.KoBindingUtils.getNodeReplacementCommentStr(e)),n=document.createComment("/"+t),i=document.createComment(o),a=document.createComment("/ko"),c=e.parentNode;if(c.insertBefore(r,e),c.insertBefore(i,e),"oj-bind-for-each"===t)for(;e.childNodes.length>0;){const t=e.childNodes[0];c.insertBefore(t,e)}c.insertBefore(a,e),c.replaceChild(n,e)}static _processBindElements(e,t){t.forEach(t=>{if(p._processBindElements(e,Array.from(t.childNodes)),1===t.nodeType){const o=t.tagName?.toLowerCase();switch(o){case"oj-bind-if":p._processOjBindIf(e,t,o);break;case"oj-if":p._processOjIf(e,t);break;case"oj-bind-text":p._processOjBindText(e,t,o);break;case"oj-bind-for-each":p._processOjBindForEach(e,t,o)}}})}static processTemplate(e){if(!e.render){if(!e._replacedNodes){const t=new Map,o=document.importNode(e,!0);Object.defineProperty(e,"_replacedNodes",{writable:!0,value:{templateCopy:o,replacementMap:t}}),p._processBindElements(t,Array.from(o.content.childNodes))}return e._replacedNodes}}}e.PreactTemplate=d,e.TemplateEngineUtils=p,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=ojtemplateengine-utils.js.map