/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","ojs/ojdataprovider","ojs/ojeventtarget","ojs/ojmap","ojs/ojset","ojs/ojbufferingutils","ojs/ojbufferingdataproviderevents","ojs/ojmutablearraytreedataprovider","ojs/ojlogger"],function(t,e,r,a,i,s,n,d,o){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,a=a&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
class h{constructor(t,e,r,n){var d;this._dataProvider=t,this._options=e,this._rootBufferingDataProvider=r,this._parentKey=n,this.TreeAsyncIterable=(d=class{constructor(t,e){this._parent=t,this._asyncIterator=e,this[Symbol.asyncIterator]=()=>this._asyncIterator}},Symbol.asyncIterator,d),this.TreeAsyncIterator=class{constructor(t,e,r){this._parent=t,this._baseIterator=e,this._params=r,this.mergedAddKeySet=new i,this.mergedItemArray=[],this.nextOffset=0,null==this._params&&(this._params={})}next(){return s.BufferingDataProviderUtils.fetchNext(this._params,this._baseIterator,this,this._parent.lastSortCriteria,this._parent.getTreeEditBuffer(),this._parent)}},this.lastIteratorMap=new a,this.lastSortCriteria=null,this.customKeyGenerator=e?.keyGenerator,this.generatedKeyMap=new a,this.totalFilteredRowCount=0,this.dataBeforeUpdated=new Map,this.dataProvider=t,this.options=e,this.rootBufferingDataProvider=r,this.rootBufferingDataProvider?(this.editBuffer=this.rootBufferingDataProvider.editBuffer,this.parentKey=this.convertKeyToKeyPath(this._parentKey)):(this.editBuffer=new s.EditBuffer,this.rootBufferingDataProvider=this,this._addEventListeners(),this.parentKey=[]);const o=this.getPathCapability(this.rootBufferingDataProvider);if(!o||"none"==o)throw new Error("BufferingTreeDataProvider only supports underlying dataProviders with keyCapability of 'pathArray' or 'pathArrayString'")}getTreeEditBuffer(){return new s.TreeEditBuffer(this.editBuffer,this.parentKey,this)}getChildDataProvider(t){let e=this.dataProvider.getChildDataProvider(t);if(!e){const r=this.convertKeyToKeyPath(t);if(!this.hasBufferedChildren(r))return null;e=new d.MutableArrayTreeDataProvider([],"@value",{useKeyPaths:"on"})}return new h(e,this.options,this.rootBufferingDataProvider,t)}hasBufferedChildren(t){const e=new s.TreeEditBuffer(this.editBuffer,t,this),r=e.getUnsubmittedItems();return 0!==e.getSubmittingItems().size||0!==r.size}containsKeys(t){return s.BufferingDataProviderUtils.containsKeys(t,this.getTreeEditBuffer(),this.dataProvider)}fetchByKeys(t){return s.BufferingDataProviderUtils.fetchByKeys(t,this.getTreeEditBuffer(),this.dataProvider)}removeItem(t){const e=this.convertKeyToKeyPath(t.metadata.key),r=this.getParentKey(e),a=s.BufferingDataProviderUtils.removeItem(t,this.getIteratorByParentKey(r),this.getTreeEditBuffer());this.getSubmittableItems().forEach(t=>{const r=this.convertKeyToKeyPath(t.item.metadata.key);this.isKeyPathDescendant(r,e)&&this.resetUnsubmittedItem(t.item.metadata.key)}),this.dispatchEvent(a),this.dispatchSubmittableChangeEvent(this.editBuffer)}updateItem(t){const e=s.BufferingDataProviderUtils.updateItem(t,this.getTreeEditBuffer());this.dispatchEvent(e),this.dispatchSubmittableChangeEvent(this.editBuffer)}getParentKey(t){return t.slice(0,t.length-1)}isKeyPathDescendant(t,e){if(e.length>=t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}addItem(r,a){const n=Object.assign({},r);if(null!=a?.nullParentKey&&null==r.metadata.key){const t=s.BufferingDataProviderUtils.generateKey(r.data,this.customKeyGenerator),e=[...this.convertKeyToKeyPath(a.nullParentKey),t];n.metadata=Object.assign({},r.metadata),n.metadata.key=this.convertKeyPathToKey(e)}else null==a?.nullParentKey&&null==r.metadata.key&&o.error("item.metadata.key is null and addDetail.nullParentKey was not provided");const d=this.convertKeyToKeyPath(n.metadata.key),h=this.getParentKey(d),f=h.length>0&&null==this.dataProvider.getChildDataProvider(h),u={...a};if(null!=a?.addBeforeKey){const e=this.convertKeyToKeyPath(a.addBeforeKey),r=this.getParentKey(e);t.KeyUtils.equals(h,r)||(o.error("addBeforeKey is not a descendant of item's parentKey"),delete u.addBeforeKey)}const l=this.getIteratorByParentKey(h),y=s.BufferingDataProviderUtils.addItem(n,this.getTreeEditBuffer(),l,u);let g=0!==h.length?[h]:[null];y.detail.add.parentKeys=g;const c=y.detail.add.addBeforeKeys[0],v=null!=c?[c]:void 0;y.detail.add.addBeforeKeys=v,f?this.dispatchEvent(new e.DataProviderRefreshEvent({keys:new i([h])})):this.dispatchEvent(y),this.dispatchSubmittableChangeEvent(this.editBuffer)}getIteratorByParentKey(t){return this.lastIteratorMap.get(t)}convertKeyToKeyPath(t){const e=this.getPathCapability(this.dataProvider);return"pathArray"===e?t:"pathArrayString"===e?JSON.parse(t):null}convertKeyPathToKey(t){const e=this.getPathCapability(this.dataProvider);return"pathArray"===e?t:"pathArrayString"===e?JSON.stringify(t):null}getPathCapability(t){return t.getCapability("key")?.structure}fetchByOffset(t){return s.BufferingDataProviderUtils.fetchByOffset(t,this.getTreeEditBuffer(),this.dataProvider)}fetchFirst(t){this.lastSortCriteria=t?t.sortCriteria:null;const e=this.dataProvider.fetchFirst(t)[Symbol.asyncIterator](),r=new this.TreeAsyncIterator(this,e,t);return this.rootBufferingDataProvider.lastIteratorMap.set(this.parentKey?this.parentKey:null,r),new this.TreeAsyncIterable(this,r)}getCapability(t){return s.BufferingDataProviderUtils.getCapability(t,this.dataProvider)}getTotalSize(){return s.BufferingDataProviderUtils.getTotalSize(this.dataProvider,this.getTreeEditBuffer())}isEmpty(){return s.BufferingDataProviderUtils.isEmpty(this.getTreeEditBuffer(),this.dataProvider)}getSubmittableItems(){return s.BufferingDataProviderUtils.getSubmittableItems(this.editBuffer)}resetAllUnsubmittedItems(){s.BufferingDataProviderUtils.resetAllUnsubmittedItems(this.editBuffer),this.dispatchSubmittableChangeEvent(this.editBuffer),this.dispatchEvent(new e.DataProviderRefreshEvent)}resetUnsubmittedItem(t){const e=this.editBuffer.getUnsubmittedItems(),r=new Set,a=e.get(t);a&&(r.add(t),e.delete(t),this.dispatchSubmittableChangeEvent(this.editBuffer),s.BufferingDataProviderUtils.resetUnsubmittedItem(a,this.editBuffer,this.dataProvider,this.getIteratorByParentKey(this.parentKey),r).then(t=>{this.dispatchEvent(t)}))}setItemStatus(t,e,r,a){const i=s.BufferingDataProviderUtils.setItemStatus(t,e,this.generatedKeyMap,this.editBuffer,r,a);i&&this.dispatchSubmittableChangeEvent(i)}dispatchSubmittableChangeEvent(t){const e=s.BufferingDataProviderUtils.getSubmittableItems(t),r=new n.BufferingDataProviderSubmittableChangeEvent(e);this.dispatchEvent(r)}_addEventListeners(){this.dataProvider.addEventListener(h._REFRESH,async t=>{this.dataBeforeUpdated=new Map;const e=await s.BufferingDataProviderUtils.handleRefreshEvent(t,this.editBuffer,this.dataProvider);this.dispatchEvent(e)}),this.dataProvider.addEventListener(h._MUTATE,t=>{this.dataBeforeUpdated=new Map;const e=s.BufferingDataProviderUtils.handleMutateEvent(t,this.editBuffer,this.getIteratorByParentKey(this.parentKey),this.generatedKeyMap,this.lastSortCriteria);t.detail.update&&t.detail.update.keys.forEach(t=>{const e=new s.TreeEditBuffer(this.editBuffer,t,this);e.getSubmittingItems().forEach(t=>{if("add"===t.operation){const r=this.convertKeyToKeyPath(t.item.metadata.key);s.BufferingDataProviderUtils.cleanUpSubmittedItem(r,e)}})}),this.dispatchEvent(e)})}createOptimizedKeySet(t){return this.dataProvider.createOptimizedKeySet(t)}createOptimizedKeyMap(t){return this.dataProvider.createOptimizedKeyMap(t)}}return h._REFRESH="refresh",h._MUTATE="mutate",r.EventTargetMixin.applyMixin(h),t._registerLegacyNamespaceProp("BufferingTreeDataProvider",h),h});
//# sourceMappingURL=ojbufferingtreedataprovider.js.map