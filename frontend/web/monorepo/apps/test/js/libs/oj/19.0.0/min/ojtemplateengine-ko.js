/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["knockout","ojs/ojkoshared","ojs/ojtemplateengine-utils","ojs/ojcore","ojs/ojhtmlutils","ojs/ojcustomelement-utils","ojs/ojcontext","ojs/ojlogger"],function(e,t,r,o,n,a,s,i){"use strict";t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,o=o&&Object.prototype.hasOwnProperty.call(o,"default")?o.default:o,s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s;const l=new WeakMap;class p{constructor(){this._bindingProvider={__ContextFor:e.contextFor,__ExtendBindingContext:t.extendBindingContext,__KoComputed:e.computed,__Observable:e.observable}}executeTemplate(t,r,o,n,s){const i=r._replacedNodes.templateCopy,l=this._createAndPopulateContainer(i,o);let p=l.childNodes;for(let e=0;e<p.length;e++){p[e][a.CACHED_BINDING_PROVIDER]="knockout"}return e.applyBindingsToDescendants(n,l),Array.prototype.slice.call(p,0)}resolveProperties(e,t,o,n,a,s,i,l){const p=t.getAttribute("data-oj-as"),c=r.TemplateEngineUtils.getContext(this._bindingProvider,e,t,a,s,p),d=this._getPropertyContributorsViaCache(t,c,o,n,l||e);return this._createComputed(d,c,i)}_getPropertyContributorsViaCache(e,t,r,o,n){let a=l.get(e);if(!a){a={},l.set(e,a);const s=this._createAndPopulateContainer(e).querySelector(r);a.evalMap=this._getPropertyEvaluatorMap(s,o,t),a.staticMap=this._getStaticPropertyMap(s,o,n)}return a}_getPropertyEvaluatorMap(e,r,o){for(var n=new Map,s=e?e.attributes:[],i=0;i<s.length;i++){var l=s[i],p=a.AttributeUtils.attributeToPropertyName(l.name).split(".");if(r.has(p[0])){var c=a.AttributeUtils.getExpressionInfo(l.value).expr;c&&n.set(p,t.createBindingExpressionEvaluator(c,o))}}return n}_getStaticPropertyMap(e,t,r){const o={};if(e){var n=e.style;n.display="none",n.position="absolute",e.setAttribute("data-oj-binding-provider","none"),r.appendChild(e),t.forEach(function(t){void 0!==e[t]&&(o[t]=e[t])}),r.removeChild(e)}return o}_createComputed(t,r,n){const a=e.pureComputed(()=>{const a={};t.evalMap.forEach((t,o)=>{var s=e.utils.unwrapObservable(t(r));n&&n(o,s),a[o[0]]=this._getMergedValue(a,o,s)});const s=o.CollectionUtils.copyInto;let i=s({},t.staticMap,null,!0);return i=s(i,a,null,!0),i});return this._wrap(a,["peek","subscribe","dispose"])}_getMergedValue(e,t,r){if(t.length<2)return r;const o=e[t[0]]||{};let n=o;const a=t.length-1;for(let e=1;e<a;e++){const r=t[e],o=n[r]||{};n[r]=o,n=o}return n[t[a]]=r,o}_wrap(e,t){const r={};return t.forEach(t=>{r[t]=e[t].bind(e)}),r}_createAndPopulateContainer(e,t){var r=document.createElement("div");t&&(r._ojReportBusy=t);for(var o=n.getTemplateContent(e),a=0;a<o.length;a++)r.appendChild(o[a]);return r}}class c{constructor(){this._defaultProps=new Map}executeTemplate(t,o,n,a,l){const p=s.getContext(o).getBusyContext(),c=e.pureComputed({read:()=>o.render(a.$current,l)}).extend({rateLimit:{timeout:0,method:(e,t)=>{let r;return()=>{if(!r){const o=p.addBusyState({description:"pending changes for the template element"});r=setTimeout(()=>{r=void 0,e(),o()},t)}}}}}),d=c();r.PreactTemplate.extendTemplate(o,r.PreactTemplate._ROW_CACHE_FACTORY,e=>{o._cachedRows.forEach(o=>{let n=e(o.currentContext,l);r.PreactTemplate.renderNodes(t,n,o,l)})});const u=document.createElement("div");n&&(u._ojReportBusy=n);const m={currentContext:a.$current,template:o,parentStub:u,computedVNode:c,vnode:void 0,nodes:void 0};return r.PreactTemplate.renderNodes(t,d,m,l),o._cachedRows.push(m),c.subscribe(e=>{const n=o._cachedRows.find(e=>e.computedVNode===c);n&&(n.nodes[0].isConnected||i.warn(`PreactTemplateEngineKo subscription is called to replace disconnected row for the template slot '${o.slot}' on ${t.tagName}`),r.PreactTemplate.renderNodes(t,e,n,l))}),m.nodes}resolveProperties(e,t,o,n,a,s,i,l){const p=t.render,c=r.TemplateEngineUtils.getResolvedDefaultProps(this._defaultProps,o,n);return r.PreactTemplate.resolveVDomTemplateProps(t,p,o,n,a,c,i)}}return new class{constructor(){this._bindingProvider={__ContextFor:e.contextFor,__ExtendBindingContext:t.extendBindingContext,__KoComputed:e.computed,__Observable:e.observable},this._templateEngineKO=new p,this._templateEngineVDOM=new c}execute(e,t,o,n,a,s){const i=t.getAttribute("data-oj-as"),l=r.TemplateEngineUtils.processTemplate(t);l&&l.replacementMap?.size>0&&(o||(o={}),o._ojNodesMap=Object.fromEntries(l.replacementMap));const p=r.TemplateEngineUtils.getContext(this._bindingProvider,e,t,o,n,i,s);return t.render?this._templateEngineVDOM.executeTemplate(e,t,a,p,s):this._templateEngineKO.executeTemplate(e,t,a,p,s)}clean(t,o){return r.PreactTemplate.findTemplateRoots(t,o).forEach(e=>{r.PreactTemplate.clean(e)}),e.cleanNode(t)}resolveProperties(e,t,r,o,n,a,s,i){return t.render?this._templateEngineVDOM.resolveProperties(e,t,r,o,n,a,s,i):this._templateEngineKO.resolveProperties(e,t,r,o,n,a,s,i)}defineTrackableProperty(e,t,o,n){r.TemplateEngineUtils.createPropertyBackedByObservable(this._bindingProvider,e,t,o,n)}}});
//# sourceMappingURL=ojtemplateengine-ko.js.map