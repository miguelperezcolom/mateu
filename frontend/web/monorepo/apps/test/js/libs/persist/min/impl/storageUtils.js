/**
 * Copyright (c) 2017, Oracle and/or its affiliates.
 * All rights reserved.
 */

define(["./logger"],(function(r){"use strict";function e(r){var t,a=[];for(var f in r)if(r.hasOwnProperty(f)){var l=r[f];if(0===f.indexOf("$")){if(i(f)){if(!(l instanceof Array))throw new Error("not a valid expression: "+r);t={operator:f,array:[]};for(var s=0;s<l.length;s++){var u=e(l[s]);t.array.push(u)}}else if(o(f))throw new Error("not a valid expression: "+r)}else if("object"!=typeof l)a.push({left:f,right:l,operator:"$eq"});else{var g={left:f};n(g,l),a.push(g)}}return a.length>1?t={operator:"$and",array:a}:1===a.length&&(t=a[0]),t}function n(r,e){var n=!1;for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];if(n||!o(t))throw new Error("parsing error "+e);r.operator=t,r.right=i,n=!0}}function t(r,e){var n=r.operator;if(i(n)){if(!r.left&&r.array instanceof Array){for(var a,s=r.array,u=0;u<s.length;u++){var g=t(s[u],e);if("$or"===n&&!0===g)return!0;if("$and"===n&&!1===g)return!1;a=g}return a}throw new Error("invalid expression tree!"+r)}if(!o(n))throw new Error("not a valid expression!"+r);var h,c=l(r.left,e),v=r.right;if("$lt"===n)return(c=(h=f(c,v))[0])<h[1];if("$gt"===n)return(c=(h=f(c,v))[0])>h[1];if("$lte"===n)return(c=(h=f(c,v))[0])<=h[1];if("$gte"===n)return(c=(h=f(c,v))[0])>=h[1];if("$eq"===n)return c===v;if("$ne"===n)return c!==v;if("$regex"===n)return null!==c.match(v);if("$exists"===n)return v?null!=c:null==c;if("$in"!==n){if("$nin"===n)return v.indexOf(c)<0;throw new Error("not a valid expression! "+r)}for(var $=0;$<v.length;$++)if(v[$]===c)return!0;return!1}function i(r){return"$and"===r||"$or"===r}function o(r){return"$lt"===r||"$gt"===r||"$lte"===r||"$gte"===r||"$eq"===r||"$ne"===r||"$regex"===r||"$exists"===r||"$in"===r||"$nin"===r}function a(r){return null!=r&&(r instanceof String||"string"==typeof r)}function f(r,e){return a(r)&&null==e?e="":a(e)&&null==r&&(r=""),[r,e]}function l(r,e){for(var n=r.split("."),t=e,i=0;i<n.length;i++)t=t[n[i]];return t}return{satisfy:function(n,i){return r.log("Offline Persistence Toolkit storageUtils: Processing selector: "+JSON.stringify(n)),!n||t(e(n),i)},getValue:l,assembleObject:function(r,e){var n;if(e){n={};for(var t=0;t<e.length;t++)for(var i=n,o=r,a=e[t].split("."),f=0;f<a.length;f++)o=o[a[f]],!i[a[f]]&&f<a.length-1&&(i[a[f]]={}),f===a.length-1?i[a[f]]=o:i=i[a[f]]}else n=r;return n},sortRows:function(r,e){return r&&Array.isArray(r)&&!(r.length<1)&&e&&Array.isArray(e)&&e.length?r.sort(function(r){return function(e,n){for(var t=0;t<r.length;t++){var i,o=r[t],a=!0;if("string"==typeof o)i=o;else{if("object"!=typeof o)throw new Error("invalid sort criteria.");var f=Object.keys(o);if(!f||1!==f.length)throw new Error("invalid sort criteria");a="asc"===o[i=f[0]].toLowerCase()}var s=l(i,e),u=l(i,n);if(s!=u)return a?s<u?-1:1:s<u?1:-1}return 0}}(e)):r}}}));