/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","ojs/ojarraydataprovider","ojs/ojeventtarget","ojs/ojlogger"],function(e,t,s,r){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;
/**
   * @preserve Copyright 2013 jQuery Foundation and other contributors
   * Released under the MIT license.
   * http://jquery.org/license
   */
class i{constructor(e,s,r){var i;this.treeData=e,this.options=s,this._rootDataProvider=r,this.TreeAsyncIterator=class{constructor(e,t){this._parent=e,this._baseIterable=t}next(){return this._baseIterable[Symbol.asyncIterator]().next().then(e=>{const t=e.value.metadata;for(let s=0;s<t.length;s++)t[s]=this._parent._getTreeMetadata(t[s],e.value.data[s]);return e})}},this.TreeAsyncIterable=(i=class{constructor(e,t){this._parent=e,this._asyncIterator=t,this[Symbol.asyncIterator]=()=>this._asyncIterator}},Symbol.asyncIterator,i);const o={...s};"on"===this.options?.enforceKeyStringify&&(o.enforceKeyStringify="off"),this._baseDataProvider=new t(e,o),this._mapKeyToNode=new Map,this._mapNodeToKey=new Map,this._mapArrayToSequenceNum=new Map,this._mapKoArrayToSubscriptions=new Map,this._mapKeyToParentNodePath=new Map,this._parentNodeKeys=new Set,this._childrenAttr=this.options&&this.options.childrenAttribute?this.options.childrenAttribute:"children",null==r?(this._parentNodePath=[],this._processTreeArray(e,[])):this._getTreeKeys(this.treeData)}containsKeys(e){return this.fetchByKeys(e).then(t=>{const s=new Set;return e.keys.forEach(e=>{null!=t.results.get(e)&&s.add(e)}),Promise.resolve({containsParameters:e,results:s})})}getCapability(e){if("key"===e){const e="on"===this.options?.enforceKeyStringify;return"on"===this.options?.useKeyPaths||"siblings"===this.options?.keyAttributesScope||e&&!this.options?.useKeyPaths?e?{structure:"pathArrayString"}:{structure:"pathArray"}:{structure:"none"}}return this._baseDataProvider.getCapability(e)}getTotalSize(){return this._baseDataProvider.getTotalSize()}isEmpty(){return this._baseDataProvider.isEmpty()}createOptimizedKeySet(e){return this._baseDataProvider.createOptimizedKeySet(e)}createOptimizedKeyMap(e){return this._baseDataProvider.createOptimizedKeyMap(e)}getChildDataProvider(e,t){const s=this._getRootDataProvider(),r=this._getNodeForKey(e);if(r){const t=this._getChildren(r);if(t){const r=new i(t,this.options,s);if(null!=r){const i=this.options?.enforceKeyStringify,o="on"===i?e:JSON.stringify(e);r._parentNodePath=s._mapKeyToParentNodePath.get(o),s.addEventListener("refresh",e=>{r._getTreeKeys(t)}),s.addEventListener("mutate",e=>{r._getTreeKeys(t)})}return r}}return null}fetchFirst(e){e=this._applyLeafNodeFilter(e);const t=this._baseDataProvider.fetchFirst(e);return new this.TreeAsyncIterable(this,new this.TreeAsyncIterator(this,t))}fetchByOffset(e){e=this._applyLeafNodeFilter(e);return this._baseDataProvider.fetchByOffset(e).then(t=>{const s=t.results,r=[];for(const e of s){let t=e.metadata;const s=e.data;t=this._getTreeMetadata(t,s),r.push({data:s,metadata:t})}const i={done:t.done,fetchParameters:t.fetchParameters,results:r};return"enabled"===e.includeFilteredRowCount&&(i.totalFilteredRowCount=t.totalFilteredRowCount),i})}fetchByKeys(e){const t=new Map;return e.keys.forEach(e=>{if(0===this._parentNodePath.length||this._parentNodeKeys.has(e)){const s=this._getNodeForKey(e);s&&t.set(e,{metadata:{key:e},data:s})}}),Promise.resolve({fetchParameters:e,results:t})}_getTreeKeys(e){const t=e instanceof Array?e:e();for(const e of t){const t=this._getKeyForNode(e);this._parentNodeKeys.add(t),e[this._childrenAttr]&&this._getTreeKeys(e[this._childrenAttr])}}_getChildren(e){return this._getVal(e,this._childrenAttr,!0)}_getRootDataProvider(){return this._rootDataProvider?this._rootDataProvider:this}_subscribeObservableArray(t,s){if("function"!=typeof t||!t.subscribe||void 0===t.destroyAll)throw new Error("Invalid data type. ArrayTreeDataProvider only supports Array or observableArray.");let r=null,i=null;const o=new Array(2);o[0]=t.subscribe(o=>{let n,a,h,l=[],d=[],y=[],u=[];const c=[];let p=null,f=null,_=null;const g=new Set,b=[],K=[];for(let e=0;e<o.length;e++)K[e]={index:o[e].index,status:o[e].status};for(let e=0;e<K.length;e++){const t=K[e].index,s=K[e].status;if("deleted"===s)for(let e=0;e<K.length;e++)"deleted"===K[e].status&&K[e].index>t&&K[e].index--;else if("added"===s)for(let e=0;e<K.length;e++)"added"===K[e].status&&K[e].index>t&&K[e].index++}for(n=0;n<K.length;n++){h=K[n].index,status=K[n].status;const t=this._getId(o[n].value);if(t)for(a=0;a<K.length;a++)if(a!==n&&h===K[a].index&&status!==K[a].status&&c.indexOf(n)<0&&b.indexOf(n)<0){const s=this._getId(o[a].value);e.Object.compareValues(t,s)&&("deleted"===status?(b.push(n),c.push(a),this._releaseNode(o[n].value)):(b.push(a),c.push(n)),this._compareChildren(o[n].value,o[a].value)||g.add(t))}}for(n=0;n<o.length;n++)if("deleted"===o[n].status&&c.indexOf(n)<0&&b.indexOf(n)<0){const e=o[n].value,t=this._getKeyForNode(e);d.push(t),l.push(e),y.push(o[n].index),this._releaseNode(e)}if(d.length>0){u=d.map(e=>({key:e}));const e=new Set;d.forEach(t=>{e.add(t)}),_={data:l,indexes:y,keys:e,metadata:u}}l=[],d=[],y=[],u=[];const A=t(),v=[],m=[],N=[],P=[];for(n=0;n<o.length;n++)if("added"===o[n].status&&b.indexOf(n)<0){const e=o[n].value,r=this._processNode(e,s,t);c.indexOf(n)<0?(d.push(r.key),l.push(e),y.push(o[n].index),u.push({key:r.key})):(v.push(r.key),m.push(e),N.push(o[n].index),P.push({key:r.key}))}if(d.length>0){const e=new Set;d.forEach(t=>{e.add(t)});const t=new Set,r=[],i=[];let o;o=this.options&&this.options.keyAttributes&&"siblings"!==this.options.keyAttributesScope&&"on"!==this.options.enforceKeyStringify?s.length>0?s[s.length-1]:null:s.length>0?s:null,y.forEach(e=>{let s;s=e>=A.length-1?null:this._getKeyForNode(A[e+1]),t.add(s),r.push(s),i.push(o)}),f={afterKeys:t,addBeforeKeys:r,parentKeys:i,data:l,indexes:y,keys:e,metadata:u}}if(v.length>0){const e=new Set;v.forEach(t=>{e.add(t)}),p={data:m,indexes:N,keys:e,metadata:P}}(f||_||p)&&(r=new e.DataProviderMutationEvent({add:f,remove:_,update:p})),g.size&&(i=new e.DataProviderRefreshEvent({keys:g}))},null,"arrayChange"),o[1]=t.subscribe(t=>{r||i?(r&&this.dispatchEvent(r),i&&this.dispatchEvent(i)):(this._flushMaps(),this._processTreeArray(this.treeData,[]),this.dispatchEvent(new e.DataProviderRefreshEvent)),r=null,i=null},null,"change"),this._mapKoArrayToSubscriptions.set(t,o)}_flushMaps(){const e=this._getRootDataProvider();e._mapKeyToNode.clear(),e._mapNodeToKey.clear(),e._mapArrayToSequenceNum.clear(),e._mapKoArrayToSubscriptions.forEach((e,t)=>{this._unsubscribeObservableArray(t)})}_unsubscribeObservableArray(e){if("function"==typeof e&&e.subscribe&&void 0!==e.destroyAll){const t=this._mapKoArrayToSubscriptions.get(e);t&&(t[0].dispose(),t[1].dispose(),this._mapKoArrayToSubscriptions.delete(e))}}_processTreeArray(e,t){let s;e instanceof Array?s=e:(this._subscribeObservableArray(e,t),s=e()),s.forEach((s,r)=>{this._processNode(s,t,e)})}_releaseTreeArray(e){let t;e instanceof Array?t=e:(this._unsubscribeObservableArray(e),t=e()),t.forEach((e,t)=>{this._releaseNode(e)})}_processNode(e,t,s){const r=this._createKeyObj(e,t,s);this._setMapEntry(r.key,e);const i=this.options?.enforceKeyStringify,o=this._getRootDataProvider(),n="on"===i?r.key:JSON.stringify(r.key);o._mapKeyToParentNodePath.set(n,r.keyPath);const a=this._getChildren(e);return a&&this._processTreeArray(a,r.keyPath),r}_releaseNode(e){const t=this._getKeyForNode(e);this._deleteMapEntry(t,e);const s=this._getChildren(e);s&&this._releaseTreeArray(s)}_createKeyObj(e,t,s){let r=this._getId(e);const i=t?t.slice():[],o=this.options?.enforceKeyStringify;return null==r?(this._setUseIndexAsKey(!0),i.push(this._incrementSequenceNum(s)),r="on"===o?JSON.stringify(i):i):("on"===o?i.push(JSON.parse(r)):i.push(r),this.options&&("siblings"===this.options.keyAttributesScope||"on"===o&&!this.options.useKeyPaths||"on"===this.options.useKeyPaths)&&(r="on"===o?JSON.stringify(i):i)),{key:r,keyPath:i}}_getId(e){let t;const s=null!=this.options?this.options.keyAttributes:null,r=this.options?.enforceKeyStringify;if(null!=s){if(Array.isArray(s)){t=[];for(let r=0;r<s.length;r++)t[r]=this._getVal(e,s[r])}else t="@value"==s?this._getAllVals(e):this._getVal(e,s);return"on"===r?JSON.stringify(t):t}return null}_getVal(e,t,s){if("string"==typeof t){const s=t.indexOf(".");if(s>0){const r=t.substring(0,s),i=t.substring(s+1),o=e[r];if(o)return this._getVal(o,i)}}return!0!==s&&"function"==typeof e[t]?e[t]():e[t]}_getAllVals(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e?e:Object.keys(e).map(t=>this._getVal(e,t))}_getNodeMetadata(e){return{key:this._getKeyForNode(e)}}_getNodeForKey(e){const t=this.options?.enforceKeyStringify,s="on"===t?e:JSON.stringify(e);return this._getRootDataProvider()._mapKeyToNode.get(s)}_getKeyForNode(e){return this._getRootDataProvider()._mapNodeToKey.get(e)}_setMapEntry(e,t){const s=this.options?.enforceKeyStringify,i=this._getRootDataProvider(),o="on"===s?e:JSON.stringify(e);i._mapKeyToNode.has(o)&&r.warn(`Duplicate key ${o} found in ArrayTreeDataProvider.  Keys must be unique when keyAttributes ${this.options.keyAttributes} is specified`),i._mapKeyToNode.set(o,t),i._mapNodeToKey.set(t,e)}_deleteMapEntry(e,t){const s=this.options?.enforceKeyStringify,r=this._getRootDataProvider(),i="on"===s?e:JSON.stringify(e);r._mapKeyToNode.delete(i),r._mapNodeToKey.delete(t)}_incrementSequenceNum(e){const t=this._getRootDataProvider(),s=t._mapArrayToSequenceNum.get(e)||0;return t._mapArrayToSequenceNum.set(e,s+1),s}_getUseIndexAsKey(){return this._getRootDataProvider()._useIndexAsKey}_setUseIndexAsKey(e){return this._getRootDataProvider()._useIndexAsKey=e}_getLeafNodeFilter(e){return{op:"$or",criteria:[e,{op:"$and",criteria:[{op:"$ne",attribute:this._childrenAttr,value:null},{op:"$ne",attribute:this._childrenAttr,value:void 0}]}]}}_applyLeafNodeFilter(e){if(e&&e.filterCriterion){const t={...e};t.filterCriterion=this._getLeafNodeFilter(t.filterCriterion),t.filterCriterion.filter=e.filterCriterion.filter,e=t}return e}_getTreeMetadata(e,t){let s=!1,r=e.key;return(null==this.options||null==this.options.keyAttributes||"siblings"==this.options.keyAttributesScope||"@index"==this.options.keyAttributes||this._getUseIndexAsKey()||"on"===this.options.enforceKeyStringify&&!this.options.useKeyPaths||"on"===this.options.useKeyPaths)&&(s=!0),s&&(r=this._parentNodePath?this._parentNodePath.slice():[],r.push(e.key)),"on"===this.options?.enforceKeyStringify&&(r=JSON.stringify(r)),e=this._getNodeMetadata(this._getNodeForKey(r))}_compareChildren(t,s){let r=!0;const i=t[this._childrenAttr],o=s[this._childrenAttr],n="function"==typeof i?i():i,a="function"==typeof o?o():o;if(!n&&a||n&&!a)r=!1;else if(n&&a)if(n.length!==a.length)r=!1;else for(let t=0;t<n.length;t++)if(!e.Object.compareValues(n[t],a[t])){r=!1;break}return r}}return s.EventTargetMixin.applyMixin(i),e._registerLegacyNamespaceProp("ArrayTreeDataProvider",i),i});
//# sourceMappingURL=ojarraytreedataprovider.js.map