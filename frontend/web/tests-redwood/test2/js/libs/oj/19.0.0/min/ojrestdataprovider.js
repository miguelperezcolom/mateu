/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","ojs/ojeventtarget","ojs/ojdataprovider","ojs/ojset","ojs/ojmap","ojs/ojmetadatautils"],function(t,e,s,r,i,a){"use strict";r=r&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i;
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
class o{constructor(t){this.options=t}async fetch(){const t=await this._createRequest(),e=this.options.fetchParameters.signal;let s;try{const r=await fetch(t,{signal:e});s=await this._parseResponse(r)}catch(t){if(this.options.errorHandler){const e={fetchType:this.options.fetchType,fetchParameters:this.options.fetchParameters,options:this.options.options,error:t};Object.defineProperty(e,"err",{get:()=>e.error,enumerable:!0}),this.options.errorHandler(e)}throw t}if(s.throwResponse)throw s.throwResponse;return s.fetchResponse}async _createRequest(){const{url:t,transforms:e,fetchParameters:s,fetchType:r,fetchOptions:i}=this.options,o=e[r].request;if(o){return o(a.deepFreeze({url:t,fetchParameters:s,fetchType:r,fetchOptions:i}))}return new Request(t)}async _parseResponse(t){const e={status:t.status,headers:t.headers,body:await this._getResponseBody(t)};if(!t.ok){const t={fetchType:this.options.fetchType,fetchParameters:this.options.fetchParameters,options:this.options.options,response:e};return this.options.errorHandler&&this.options.errorHandler(t),{throwResponse:e}}return{fetchResponse:await this._applyResponseTransforms(e)}}async _getResponseBody(t){try{return await t.json()}catch{return}}async _applyResponseTransforms({status:t,headers:e,body:s}){const{transforms:r={},fetchType:i}=this.options,o=r[i].response;let n,h,c,l,f;if(o){const r=a.deepFreeze({status:t,headers:e,body:s}),i=await o(r);n=i.data,h=i.keys,c=i.metadata,l=i.hasMore,f=i.totalSize}else null!==s&&"object"==typeof s&&(n=s.data,h=s.keys,c=s.metadata,l=s.hasMore,f=s.totalSize);if(!Array.isArray(n))throw'"data" should be an array. Please use the response transform to extract the data array from the response if needed.';return{data:n,keys:h,metadata:c,hasMore:l,totalSize:f}}}const n="fetchByKeys",h="fetchByOffset",c="fetchFirst";class l{constructor(t){var e;this.options=t,this._totalSize=-1,this._sequenceNum=0,this._mapClientIdToProps=new Map,this.AsyncIterable=(e=class{constructor(t){this._asyncIterator=t,this[Symbol.asyncIterator]=function(){return this._asyncIterator}}},Symbol.asyncIterator,e),this.AsyncIterator=class{constructor(t,e,s,r,i){this._parent=t,this._nextFunc=e,this._fetchParameters=s,this._offset=r,this._iterationLimit=i,this._rowsFetched=0,this._clientId=s&&s.clientId||Symbol(),t._mapClientIdToProps.set(this._clientId,{hasMore:!0,offset:r})}async next(){const t=this._parent._mapClientIdToProps.get(this._clientId),e=t.offset,s=t.hasMore,{result:r,offset:i,hasNoMore:a}=await this._nextFunc(c,this._fetchParameters,e,s);this._parent._mapClientIdToProps.set(this._clientId,{hasMore:!a,offset:i});const o=r.value.data;return this._rowsFetched+=o.length,Number.isInteger(this._iterationLimit)&&this._rowsFetched>=this._iterationLimit&&(r.done=!0),r}},this.AsyncIteratorYieldResult=class{constructor(t){this.value=t,this.done=!1}},this.AsyncIteratorReturnResult=class{constructor(t){this.value=t,this.done=!0}};const s=this._getCapabilitiesFromOptions();if(this.options.restHelper){let t=!1;if((null!=s.fetchByKeys&&null==this.options.restHelper.fetchByKeys||null!=s.fetchByOffset&&null==this.options.restHelper.fetchByOffset||null==this.options.restHelper.fetchFirst)&&(t=!0),t)throw new Error("Rest Helper does not match capabilities")}}fetchFirst(t){return new this.AsyncIterable(new this.AsyncIterator(this,this._fetchFrom.bind(this),t,0,this.options.iterationLimit))}async fetchByKeys(t){if(!t)throw Error('"keys" is a required parameter');const e=this._getCapabilitiesFromOptions();if(e.fetchByKeys){if("lookup"===e.fetchByKeys.implementation)return this._fetchByKeysLookup(t);if("batchLookup"===e.fetchByKeys.implementation)return this._fetchByKeysBatchLookup(t)}return this._fetchByKeysIteration(t)}async fetchByOffset(t){if(!t)throw Error('"offset" is a required parameter');const e=t.offset>0?t.offset:0,s=this._getCapabilitiesFromOptions();return s.fetchByOffset&&"randomAccess"===s.fetchByOffset.implementation?this._fetchByOffsetRandomAccess(t,e):this._fetchByOffsetIteration(t,e)}async containsKeys(t){const e=new r,s=await this.fetchByKeys(t);return t.keys.forEach(t=>{null!=s.results.get(t)&&e.add(t)}),{containsParameters:t,results:e}}createOptimizedKeySet(t){return t?new r(t):new r}createOptimizedKeyMap(t){return t?new i(t):new i}isEmpty(){return"unknown"}getCapability(t){const e=this._getCapabilitiesFromOptions();switch(t){case"sort":return e.sort;case"filter":return e.filter;case"key":return e.key;case c:return this._getFetchCapability(c);case n:return this._getFetchCapability(n);case h:return this._getFetchCapability(h);case"fetchCapability":return l._getFetchCapabilityDefaults();default:return}}getTotalSize(){return Promise.resolve(this._totalSize)}refresh(){this.dispatchEvent(new s.DataProviderRefreshEvent)}mutate(t){const{add:e,remove:r}=t;this._adjustIteratorOffset(r,e),this.dispatchEvent(new s.DataProviderMutationEvent(t))}async _fetchFrom(t,e={},r,i){const{signal:a}=e;return s.wrapWithAbortHandling(a,async(a,n)=>{if(i){const i=this._convertFetchListToFetchByOffsetParameters(e,r),n=this._getFetchSize(i),h={...i,size:n,filterCriterion:s.FilterFactory.getFilter({filterDef:i.filterCriterion,filterOptions:this.options})};let c;if(s.FilterUtils.validateFilterCapabilities(this.getCapability("filter"),h.filterCriterion),this.options.restHelper){const e=this.options.restHelper[t];if(!e)throw new Error(`Rest Helper does not match capabilities: ${t}`);c=await e({options:this.options,fetchParameters:h})}else{const e=new o({fetchType:t,fetchParameters:h,url:this.options.url,transforms:this.options.transforms,fetchOptions:{textFilterAttributes:this.options.textFilterAttributes},errorHandler:this.options.error,options:this.options});c=await e.fetch()}const{data:l,totalSize:f,hasMore:p}=c;let u=this._getFetchResultMetaData(c);const y=this._mergeSortCriteria(e.sortCriteria);y&&(e={...e,sortCriteria:y});const d={fetchParameters:e,data:l,metadata:u};return Number.isInteger(f)&&this._totalSize!==f&&(this._totalSize=f),"boolean"==typeof p&&(p||l.length>0)?a({result:new this.AsyncIteratorYieldResult(d),offset:r+l.length,hasNoMore:!p}):a({result:new this.AsyncIteratorReturnResult(d),offset:r+l.length,hasNoMore:!p})}return a({result:new this.AsyncIteratorReturnResult({fetchParameters:e,data:[],metadata:[]}),offset:r,hasNoMore:!0})},!0)}async _fetchByKeysIteration(t){const e=this._convertFetchByKeysToFetchListParameters(t),s=this.fetchFirst(e)[Symbol.asyncIterator](),r=[],i=[];let a=!1;for(;!a;){const e=await s.next(),{data:o,metadata:n}=e.value;n.forEach((e,s)=>{t.keys.has(e.key)&&(r.push(o[s]),i.push(e))}),a=t.keys.size===i.length||e.done}return this._createFetchByKeysResults(t,r,i)}async _fetchByKeysLookup(t){const{signal:e}=t;return s.wrapWithAbortHandling(e,async(e,s)=>{const r=[],i=[];let a=[];for(let e of t.keys)if(this.options.restHelper){const s=this.options.restHelper.fetchByKeys;if(!s)throw new Error(`Rest Helper does not match capabilities: ${n}`);r.push(s({options:this.options,fetchParameters:{...t,keys:new Set([e])}}))}else{const s=new o({fetchType:n,fetchParameters:{...t,keys:new Set([e])},url:this.options.url,transforms:this.options.transforms,errorHandler:this.options.error,options:this.options});r.push(s.fetch())}return(await Promise.all(r)).forEach(t=>{t.data.forEach(t=>{i.push(t)});this._getFetchResultMetaData(t).forEach(t=>{a.push(t)})}),e(this._createFetchByKeysResults(t,i,a))},!0)}async _fetchByKeysBatchLookup(t){const{signal:e}=t;return s.wrapWithAbortHandling(e,async(e,s)=>{let r;if(this.options.restHelper){const e=this.options.restHelper.fetchByKeys;if(!e)throw new Error(`Rest Helper does not match capabilities: ${n}`);r=await e({options:this.options,fetchParameters:t})}else{const e=new o({fetchType:n,fetchParameters:t,url:this.options.url,transforms:this.options.transforms,errorHandler:this.options.error,options:this.options});r=await e.fetch()}const i=this._getFetchResultMetaData(r);return e(this._createFetchByKeysResults(t,r.data,i))},!0)}async _fetchByOffsetRandomAccess(t,e){const s=await this._fetchFrom(h,this._convertFetchByOffsetToFetchListParameters(t),e,!0);s.hasNoMore&&(s.result.done=!0);const{value:r,done:i}=s.result,{data:a,metadata:o}=r,n=a.map((t,e)=>({metadata:o[e],data:t})),c=this._mergeSortCriteria(t.sortCriteria);return c&&(t={...t,sortCriteria:c}),{fetchParameters:t,results:n,done:i}}async _fetchByOffsetIteration(t,e){const s=this._convertFetchByOffsetToFetchListParameters(t),r=this.fetchFirst(s)[Symbol.asyncIterator](),i=[],a=[],o=this._getFetchSize(t);let n=!1,h=!0;for(;!n;){const t=await r.next(),s=t.value,{data:c,metadata:l}=s;h=t.done,c.forEach(t=>{i.push(t)}),l.forEach(t=>{a.push(t)}),n=void 0!==i[e+o-1]||h}const c=e,l=e+o,f=i.slice(c,l),p=a.slice(c,l),u=f.map((t,e)=>({metadata:p[e],data:t})),y=this._mergeSortCriteria(t.sortCriteria);return y&&(t={...t,sortCriteria:y}),{fetchParameters:t,results:u,done:h}}_generateKeysFromData(t){const e=null!=this.options?this.options.keyAttributes:null,s=this.options?.enforceKeyStringify;return t.map(t=>{let r=this._getId(t);return null!=r&&"@index"!=e||(r="on"===s?JSON.stringify(this._sequenceNum++):this._sequenceNum++),r})}_generateMetadataFromKeys(t){return t.map(t=>({key:t}))}_getId(t){let e,s=null;if(null!=this.options&&null!=this.options.keyAttributes&&(s=this.options.keyAttributes),null!=s){if(Array.isArray(s)){let r;for(e=[],r=0;r<s.length;r++)e[r]=this._getVal(t,s[r])}else e=this._getVal(t,s);return e}return null}_getVal(t,e){const s=e.indexOf(".");if(s>0){const r=e.substring(0,s),i=e.substring(s+1),a=t[r];if(a)return this._getVal(a,i)}return"function"==typeof t[e]?t[e]():t[e]}_convertFetchByOffsetToFetchListParameters(t){return{size:t.size,sortCriteria:t.sortCriteria,filterCriterion:t.filterCriterion,attributes:t.attributes,clientId:t.clientId,signal:t.signal}}_convertFetchListToFetchByOffsetParameters(t,e){return{offset:e,size:t.size,sortCriteria:t.sortCriteria,filterCriterion:t.filterCriterion,attributes:t.attributes,clientId:t.clientId,signal:t.signal}}_convertFetchByKeysToFetchListParameters(t){return{attributes:t.attributes,signal:t.signal}}_createFetchByKeysResults(t,e,s){const r=new Map;return e.forEach((t,e)=>{t&&r.set(s[e].key,{metadata:s[e],data:t})}),{fetchParameters:t,results:r}}_getFetchCapability(t){const e=this._getCapabilitiesFromOptions(),s=l._getFetchCapabilityDefaults();return t===c?{...s,iterationSpeed:"delayed"}:e[t]?{...s,...e[t]||{}}:null}static _getFetchCapabilityDefaults(){return{caching:"none",attributeFilter:{expansion:{},ordering:{},defaultShape:{features:new Set(["exclusion"])}}}}_getCapabilitiesFromOptions(){return this.options.capabilities||{}}_getFetchSize(t){return Number.isInteger(t.size)&&t.size>0?t.size:25}_mergeSortCriteria(t){const e=null!=this.options?this.options.implicitSort:null;if(null!=e){if(null==t)return e;const s=t.slice(0);let r,i,a;for(r=0;r<e.length;r++){for(a=!1,i=0;i<s.length;i++)s[i].attribute==e[r].attribute&&(a=!0);a||s.push(e[r])}return s}return t}_getFetchResultMetaData(t){const e=t.keys||this._generateKeysFromData(t.data);let s=t.metadata||this._generateMetadataFromKeys(e);const r=this.options?.enforceKeyStringify;return s=s.map(t=>{let e={...t};return"on"===r&&(e.key=JSON.stringify(e.key)),e}),s}_adjustIteratorOffset(t,e){const s=t?t.indexes:null,r=e?e.indexes:null;this._mapClientIdToProps.forEach((t,e)=>{let i=t.offset,a=0;s&&s.forEach(function(t){t<i&&++a}),i-=a;let o=!1;r&&r.forEach(function(t){t<i?++i:o=!0}),o?this._mapClientIdToProps.set(e,{hasMore:!0,offset:i}):this._mapClientIdToProps.set(e,{hasMore:t.hasMore,offset:i})})}}e.EventTargetMixin.applyMixin(l),t.RESTDataProvider=l,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ojrestdataprovider.js.map