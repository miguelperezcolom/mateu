/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["exports","ojs/ojdataprovider","ojs/ojset","ojs/ojcore-base","ojs/ojmap","ojs/ojlogger"],function(t,e,s,i,n,r){"use strict";s=s&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s,i=i&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i,n=n&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n;const o="@default",l=()=>{const t=new Set;return t.add("exclusion"),{caching:"all",attributeFilter:{expansion:{},ordering:{},defaultShape:{features:t}}}},a=t=>(Object.defineProperty(t,Symbol.for("oj-vb-no-object-proxy"),{value:!0}),t),u=(t,e)=>{if("string"==typeof e){const s=e.indexOf(".");if(s>0){const i=e.substring(0,s),n=e.substring(s+1),r=t[i];if(r)return u(r,n)}}return"function"==typeof t[e]?t[e]():t[e]},h=(t,e,s)=>{if(Array.isArray(t)){let i,n=!1;t.forEach(t=>{t!==o&&t.name!==o||(n=!0)}),Object.keys(e).forEach(r=>{if(n){let n,o=!1,l=r;for(i=0;i<t.length;i++)if(n=t[i]instanceof Object?t[i].name:t[i],n.startsWith("!")){if(n=n.substr(1,n.length-1),n===r){o=!0;break}}else if(n===r){l=t[i];break}o||h(l,e,s)}else t.forEach(t=>{let i;i=t instanceof Object?t.name:t,i.startsWith("!")||i!==r||h(t,e,s)})})}else if(t instanceof Object){const i=t.name,n=t.attributes;if(i&&!i.startsWith("!"))if(e[i]instanceof Object&&!Array.isArray(e[i])&&n){const t={};h(n,e[i],t),s[i]=t}else if(Array.isArray(e[i])&&n){let t;s[i]=[],e[i].forEach((e,r)=>{t={},h(n,e,t),s[i][r]=t})}else p(s,e,i)}else p(s,e,t)},p=(t,e,s)=>{t&&e&&Object.defineProperty(t,s,{get:()=>e[s],set(t){e[s]=t},enumerable:!0})},c=(t,e)=>a({metadata:a({key:t}),data:e}),f=t=>t.map(t=>a({key:t})),d=(t,e)=>{let s,n=-1;for(s=0;s<e.length;s++)if(i.Object.compareValues(e[s],t)){n=s;break}return n};t.ArrayDataProviderImpl=class{constructor(t,s){var i;this.options=t,this.implOptions=s,this._sequenceNum=0,this._mutationSequenceNum=0,this._mapClientIdToIteratorInfo=new Map,this.AsyncIterable=(i=class{constructor(t){this._asyncIterator=t,this[Symbol.asyncIterator]=()=>this._asyncIterator}},Symbol.asyncIterator,i),this.AsyncIterator=class{constructor(t,e,s,i){this._parent=t,this._nextFunc=e,this._params=s,this._offset=i,this._clientId=s&&s.clientId||Symbol(),t._mapClientIdToIteratorInfo.set(this._clientId,{offset:i,rowKey:null,filterCriterion:s?.filterCriterion,sortCriteria:s?.sortCriteria,fetchedRowKeys:[]}),this._cacheObj={mutationSequenceNum:t._mutationSequenceNum}}next(){const t=(t,e)=>{const s=this._parent._mapClientIdToIteratorInfo.get(this._clientId),i=s?s.offset:null,n=this._nextFunc(this._params,i,!1,this._cacheObj);Object.defineProperty(n.result.value,"totalFilteredRowCount",{get:()=>{if("enabled"===this._params?.includeFilteredRowCount)return(void 0===this._totalFilteredRowCount||this._parent._resetTotalFilteredRowCount)&&(this._totalFilteredRowCount=this._parent._getTotalFilteredRowCount(this._params),this._parent._resetTotalFilteredRowCount=!1),this._totalFilteredRowCount},enumerable:!0});const r=n.result.value.metadata?.map(t=>t.key),o=r?s?.fetchedRowKeys?s.fetchedRowKeys.concat(r):r:[],l=o.length>0?o[o.length-1]:null;return this._parent._mapClientIdToIteratorInfo.set(this._clientId,{offset:n.offset,rowKey:l,filterCriterion:this._params?.filterCriterion,sortCriteria:this._params?.sortCriteria,fetchedRowKeys:o}),t(n.result)};return this._parent.implOptions.supportAbortController?e.wrapWithAbortHandling(this._params?.signal,t,!1):t(Promise.resolve.bind(Promise),Promise.reject.bind(Promise))}}}containsKeys(t){return this.fetchByKeys(t).then(e=>{const i=new s;return t.keys.forEach(t=>{null!=e.results.get(t)&&i.add(t)}),Promise.resolve(a({containsParameters:t,results:i}))})}fetchByKeys(t){const s=(e,s)=>{this.implOptions.generateKeysIfNeeded(()=>this.generateKeys());const r=new n,o=this.implOptions.getKeys(),l=null!=t?t.attributes:null;let u,p=0;if(t){const s=this.implOptions.getData();return t.keys.forEach(t=>{for(u=null,p=0;p<o.length;p++)if(i.Object.compareValues(o[p],t)){u=p;break}if(null!=u&&u>=0){let e=s[u];if(l&&l.length>0){const t={};h(l,e,t),e=t}r.set(t,c(t,e))}}),e(a({fetchParameters:t,results:r}))}return s("Keys are a required parameter")};return this.implOptions.supportAbortController?e.wrapWithAbortHandling(t?.signal,s,!1):s(Promise.resolve.bind(Promise),Promise.reject.bind(Promise))}fetchByOffset(t){const s=(e,s)=>{const i=null!=t?t.size:-1,n=null!=t?t.sortCriteria:null,r=null!=t&&t.offset>0?t.offset:0,o=null!=t?t.attributes:null,l=null!=t?t.filterCriterion:null;this.implOptions.generateKeysIfNeeded(()=>this.generateKeys());let u=[],h=!0;if(t){const s={size:i,sortCriteria:n,filterCriterion:l,attributes:o},p=this._fetchFrom(s,r,!0).result,f=p.value.fetchParameters;f.sortCriteria!==n&&(t={...t,sortCriteria:f.sortCriteria});const d=p.value;h=p.done;const m=d.data,y=d.metadata.map(t=>t.key);return u=m.map((t,e)=>c(y[e],t)),e(Object.assign(a({fetchParameters:t,results:u,done:h}),"enabled"===t?.includeFilteredRowCount?{totalFilteredRowCount:this._getTotalFilteredRowCount(t)}:null))}return s("Offset is a required parameter")};return this.implOptions.supportAbortController?e.wrapWithAbortHandling(t?.signal,s,!1):s(Promise.resolve.bind(Promise),Promise.reject.bind(Promise))}fetchFirst(t){return new this.AsyncIterable(new this.AsyncIterator(this,this._fetchFrom.bind(this),t,0))}getTotalSize(){return Promise.resolve(this.implOptions.getData().length)}isEmpty(){return this.implOptions.getData().length>0?"no":"yes"}_getTotalFilteredRowCount(t){const s=this.implOptions.getData(),i=t?t.filterCriterion:null;let n=-1;if(i){n=0;let t=e.FilterFactory.getFilter({filterDef:i,filterOptions:this.options});for(let e=0;e<s.length;e++)t.filter(s[e])&&++n}else n=s.length;return n}getId(t){let e;const s=this.options?.keyAttributes,i=this.options?.enforceKeyStringify;if(null!=s){if(Array.isArray(s)){let i;for(e=[],i=0;i<s.length;i++)e[i]=u(t,s[i])}else e="@value"===s?"string"==typeof(n=t)||"number"==typeof n||"boolean"==typeof n?n:Object.keys(n).map(t=>u(n,t)):u(t,s);return"on"===i?JSON.stringify(e):e}return null;var n}generateKeys(){const t=this.options?.keyAttributes,e=this.options?.enforceKeyStringify,s=[],i=this.implOptions.getData();for(let n=0;n<i.length;n++){let r=this.getId(i[n]);null!=r&&"@index"!==t||(r="on"===e?JSON.stringify(this._sequenceNum++):this._sequenceNum++),s.push(r)}return s}_fetchFrom(t,s,i,n){const r=null!=t?t.attributes:null;this.implOptions.generateKeysIfNeeded(()=>this.generateKeys());const o=null!=t?t.sortCriteria:null,l=this._getCachedIndexMap(o,n),u=this.implOptions.getData(),p=this.implOptions.getKeys(),c=l.map(t=>u[t]),d=l.map(t=>p[t]),m=null!=t?t.size>0?t.size:t.size<0?p.length:25:25;let y=s+m<c.length;const g=this.implOptions.mergeSortCriteria(o);null!=g&&(t={...t,sortCriteria:g});let O,b=[],_=[],w=0;if(null!=t&&t.filterCriterion){let i=null;i=e.FilterFactory.getFilter({filterDef:t.filterCriterion,filterOptions:this.options});let n=0;for(;b.length<m&&n<c.length;)i.filter(c[n])&&(w>=s&&(b.push(c[n]),_.push(d[n])),w++),n++;y=n<c.length}else b=c.slice(s,s+m),_=d.slice(s,s+m);w=s+b.length,O=b.map(t=>{if(r&&r.length>0){const e={};h(r,t,e),t=e}return t});const C=f(_),K=a({fetchParameters:t,data:O,metadata:C}),x=!(i?y:K.data.length>0);return{result:a({value:K,done:x}),offset:w}}_getCachedIndexMap(t,e){if(e&&e.indexMap&&e.mutationSequenceNum===this._mutationSequenceNum)return e.indexMap;const s=this.implOptions.getData().map((t,e)=>e),i=this._sortData(s,t);return e&&(e.indexMap=i,e.mutationSequenceNum=this._mutationSequenceNum),i}_sortData(t,e){const s=this.implOptions.getData(),i=t.map(t=>({index:t,value:s[t]}));return null!=e&&i.sort(this.implOptions.getSortComparator(e)),i.map(t=>t.index)}queueMutationEvent(t){this._mutationEvent=this._createMutationEvent(t)}flushQueue(){this.implOptions.dispatchEvent(this._mutationEvent??new e.DataProviderRefreshEvent),this._mutationEvent=null}_createMutationEvent(t){let n,o,l,u,h,p=[],c=[],m=[];const y=[];this._mutationSequenceNum++;let g=!0,O=!0;this._resetTotalFilteredRowCount=!0,t.forEach(t=>{"deleted"===t.status?(g=!1):"added"===t.status&&(O=!1)});const b=[],_=[];let w=null,C=null,K=null;const x=this.implOptions.generateKeysIfNeeded(()=>this.generateKeys());if(!g&&!O){for(n=0;n<t.length;n++){u=t[n].index,h=t[n].status;const e=this.getId(t[n].value);for(o=0;o<t.length;o++)o!==n&&u===t[o].index&&h!==t[o].status&&b.indexOf(n)<0&&_.indexOf(n)<0&&(null==e||i.Object.compareValues(e,this.getId(t[o].value)))&&("deleted"===h?(_.push(n),b.push(o)):(_.push(o),b.push(n)))}for(n=0;n<t.length;n++)if(b.indexOf(n)>=0){const e=this.implOptions.getKeys()[t[n].index];c.push(e),p.push(t[n].value),m.push(t[n].index)}c.length>0&&(w=a({keys:new s(c),metadata:f(c),data:p,indexes:m}))}if(p=[],c=[],m=[],!g){for(n=0;n<t.length;n++)"deleted"===t[n].status&&b.indexOf(n)<0&&_.indexOf(n)<0&&(l=this.implOptions.getKeyForDelete(t[n],x),c.push(l),p.push(t[n].value),m.push(t[n].index));c.length>0&&c.forEach(t=>{const e=d(t,this.implOptions.getKeys());e>=0&&this.implOptions.spliceKeys(e,1)}),c.length>0&&(K=a({keys:new s(c),metadata:f(c),data:p,indexes:m}))}if(p=[],c=[],m=[],!O){const e=null==this.implOptions.getKeys()||!(this.implOptions.getKeys().length>0);for(n=0;n<t.length;n++)"added"===t[n].status&&b.indexOf(n)<0&&_.indexOf(n)<0&&(l=this.getId(t[n].value),null==l&&(x||this.implOptions.keysSpecified)&&(l=this.implOptions.getKeys()[t[n].index]),null==l?(l=this._sequenceNum++,this.implOptions.spliceKeys(t[n].index,0,l)):e||-1===d(l,this.implOptions.getKeys())?this.implOptions.spliceKeys(t[n].index,0,l):x||this.implOptions.keysSpecified||(r.warn("added row has duplicate key "+l),this.implOptions.spliceKeys(t[n].index,0,l)),c.push(l),p.push(t[n].value),m.push(t[n].index));for(n=0;n<t.length;n++)if("added"===t[n].status&&b.indexOf(n)<0&&_.indexOf(n)<0){let e=this.implOptions.getKeys()[t[n].index+1];e=null==e?null:e,y.push(e)}c.length>0&&(C=a({keys:new s(c),afterKeys:new s(y),addBeforeKeys:y,metadata:f(c),data:p,indexes:m}))}return this._adjustIteratorOffset(K,C),new e.DataProviderMutationEvent(a({add:C,remove:K,update:w}))}resetTotalFilteredRowCount(){this._resetTotalFilteredRowCount=!0}_adjustIteratorOffset(t,e){const s=t?.indexes,i=e?.indexes.slice(0);this._mapClientIdToIteratorInfo.forEach((n,r)=>{if(n.offset>0){const o=n.filterCriterion,l=n.sortCriteria,a=l?this.implOptions.getSortComparator(l):null;if(s&&(s.forEach((e,s)=>{const i=Array.from(t.keys)[s],r=d(i,n.fetchedRowKeys);r>-1&&(--n.offset,n.fetchedRowKeys.splice(r,1))}),n.rowKey=n.fetchedRowKeys[n.fetchedRowKeys.length-1]),i){const t=e.data.slice(0),s=Array.from(e.keys);if(null!=o?.filter)for(let e=i.length-1;e>=0;e--){let n=t[e];null!=n&&o.filter(n)&&(i.splice(e,1),t.splice(e,1),s.splice(e,1))}if(null!=a){const t=[...n.fetchedRowKeys,...s],e=this.implOptions.getData(),i=new Map;this.implOptions.getKeys().forEach((t,e)=>{i.set(t,e)}),t.sort((t,s)=>{const n=e[i.get(t)],r=e[i.get(s)];return a({value:n},{value:r})}),n.fetchedRowKeys=t.slice(0,d(n.rowKey,t)+1),n.offset=n.fetchedRowKeys.length}else i.forEach((t,e)=>{const i=s[e];if(t<d(n.rowKey,this.implOptions.getKeys())){++n.offset;d(i,n.fetchedRowKeys)<0&&n.fetchedRowKeys.splice(t,0,i)}})}this._mapClientIdToIteratorInfo.set(r,n)}})}},t.createOptimizedKeyMap=t=>{if(t){const e=new n;return t.forEach((t,s)=>{e.set(s,t)}),e}return new n},t.createOptimizedKeySet=t=>new s(t),t.getCapability=t=>"sort"===t?{attributes:"multiple"}:"fetchByKeys"===t?Object.assign({implementation:"lookup"},l()):"fetchByOffset"===t?Object.assign({implementation:"randomAccess",totalFilteredRowCount:"exact"},l()):"fetchFirst"===t?Object.assign({iterationSpeed:"immediate",totalFilteredRowCount:"exact"},l()):"fetchCapability"===t?l():"filter"===t?{operators:["$co","$eq","$ew","$pr","$gt","$ge","$lt","$le","$ne","$regex","$sw","$exists"],attributeExpression:["*"],textFilter:{},textFilterMatching:{matchBy:["startsWith","contains","phrase"]},nestedFilter:{},collationOptions:{sensitivity:["base","accent","case","variant"]}}:null,t.getVal=u,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=ojarraydataproviderimpl.js.map