/**
 * Copyright (c) 2017, Oracle and/or its affiliates.
 * All rights reserved.
 */

define(["./persistenceUtils","./impl/logger"],(function(e,r){"use strict";return{getShredder:function(n,t,s){return function(i){r.log("Offline Persistence Toolkit oracleRestJsonShredding: Shredding Response");var o=i.clone(),a=o.headers.get("X-ORACLE-DMS-ECID");return o.text().then((function(i){var o=[],c=[],u="collection";if(null!=i&&i.length>0)try{var d=JSON.parse(i);if(null!=d.items)o=d.items.map((function(e){if(t instanceof Array){var r=[];return t.forEach((function(n){r.push(e[n])})),r}return e[t]})),c=d.items;else{if(t instanceof Array){var l=[];t.forEach((function(e){l.push(d[e])})),o[0]=l}else o[0]=d[t];c[0]=d,u="single"}}catch(e){r.log("Offline Persistence Toolkit oracleRestJsonShredding: Error during shredding: "+e)}var f=e._mapData(o,c,s);return[{name:n,resourceIdentifier:a,keys:f.keys,data:f.data,resourceType:u}]}))}},getUnshredder:function(n){return function(t,s){if(r.log("Offline Persistence Toolkit oracleRestJsonShredding: Unshredding Response"),!t||1!==t.length)throw new Error({message:"shredded data is not in the correct format."});var i=e._unmapData(t[0].keys,t[0].data,n),o=function(e){var r=e[0].data;return r&&1===r.length&&"single"===e[0].resourceType?r[0]:{items:r,count:r.length}}([{keys:i.keys,data:i.data,resourceType:t[0].resourceType}]);return e.setResponsePayload(s,o).then((function(e){return e.headers.set("x-oracle-jscpt-cache-expiration-date",""),e}))}}}}));