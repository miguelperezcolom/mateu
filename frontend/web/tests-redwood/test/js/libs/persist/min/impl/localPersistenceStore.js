/**
 * Copyright (c) 2017, Oracle and/or its affiliates.
 * All rights reserved.
 */

define(["./keyValuePersistenceStore","./logger"],(function(e,t){"use strict";var r=function(t){e.call(this,t)};return(r.prototype=new e).Init=function(e){return this._version=e&&e.version||"0",Promise.resolve()},r.prototype._insert=function(e,t,r){var o=this._createRawKey(e),i={key:e,metadata:t,value:r},n=JSON.stringify(i);return localStorage.setItem(o,n),Promise.resolve()},r.prototype.removeByKey=function(e){t.log("Offline Persistence Toolkit localPersistenceStore: removeByKey() with key: "+e);var r=this;return this.findByKey(e).then((function(t){if(t){var o=r._createRawKey(e);return localStorage.removeItem(o),Promise.resolve(!0)}return Promise.resolve(!1)}))},r.prototype._createRawKey=function(e){return this._name+this._version+e.toString()},r.prototype.keys=function(){t.log("Offline Persistence Toolkit localPersistenceStore: keys()");for(var e=Object.keys(localStorage),r=[],o=0;o<e.length;o++){var i=this._name+this._version,n=e[o];if(0===n.indexOf(i)){var s=localStorage.getItem(n);if(s)try{var a=JSON.parse(s).key;a?r.push(a):r.push(n.slice(i.length))}catch(e){t.log("data is not in valid JSON format: "+s);continue}}}return Promise.resolve(r)},r.prototype.getItem=function(e){t.log("Offline Persistence Toolkit localPersistenceStore: getItem() with key: "+e);var r=this._createRawKey(e),o=localStorage.getItem(r);if(!o)return Promise.resolve();try{var i=JSON.parse(o);return Promise.resolve(i)}catch(e){return Promise.resolve()}},r}));