/**
 * @license
 * Copyright (c) 2014, 2025, Oracle and/or its affiliates.
 * Licensed under The Universal Permissive License (UPL), Version 1.0
 * as shown at https://oss.oracle.com/licenses/upl/
 * @ignore
 */
define(["ojs/ojcore-base","ojs/ojset","ojs/ojeventtarget","ojs/ojobservable","ojs/ojmap","ojs/ojdataprovider","ojs/ojkeyset"],function(e,t,s,i,a,r,n){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e,t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t,a=a&&Object.prototype.hasOwnProperty.call(a,"default")?a.default:a;
/**
     * @preserve Copyright 2013 jQuery Foundation and other contributors
     * Released under the MIT license.
     * http://jquery.org/license
     */
class h{constructor(e,t){var s;this.dataProvider=e,this.options=t,this._cacheInstantiated=!1,this._createAddItem=(e,t)=>{const s=e.key,i=e.parentKey,a=null===this.getChildDataProvider(s);let r=0;if(null!=i){r=this._getItemByKey(i).metadata.treeDepth+1}const n=this._getInsertIndexFromParent(r,t);return this._updateItemMetadata(new this.Item(this,e.metadata,e.data),i,r,n,a)},this._unshiftAddToCache=e=>{let t=this._createAddItem(e,0);return this._cache.unshift(t),this._incrementIndexFromParent(1,t.metadata.treeDepth),this._incrementIteratorOffset(0),t},this._pushAddToCache=e=>{let t=this._createAddItem(e,this._cache.length);return this._cache.push(t),this._incrementIteratorOffset(this._cache.length-1),t},this._spliceAddToCache=(e,t)=>{let s=this._createAddItem(e,t);return this._cache.splice(t,0,s),this._incrementIndexFromParent(t+1,s.metadata.treeDepth),this._incrementIteratorOffset(t),s},this.AsyncIterable=(s=class{constructor(e,t){this._parent=e,this._asyncIterator=t,this[Symbol.asyncIterator]=()=>this._asyncIterator,this._clientId=Symbol(),this._parent._mapClientIdToIteratorInfo.set(this._clientId,0)}},Symbol.asyncIterator,s),this.AsyncIterator=class{constructor(e,t,s){this._parent=e,this._nextFunc=t,this._params=s}next(){return this._nextFunc(this._params)}},this.AsyncIteratorYieldResult=class{constructor(e,t){this._parent=e,this.value=t,this.value=t,this.done=!1}},this.AsyncIteratorReturnResult=class{constructor(e,t){this._parent=e,this.value=t,this.value=t,this.done=!0}},this.Item=class{constructor(e,t,s){this._parent=e,this.metadata=t,this.data=s,this.metadata=t,this.data=s}},this.FlattenedTreeItemMetadata=class{constructor(e,t,s,i,a,r){this._parent=e,this.key=t,this.parentKey=s,this.indexFromParent=i,this.treeDepth=a,this.isLeaf=r,this.key=t,this.parentKey=s,this.indexFromParent=i,this.treeDepth=a,this.isLeaf=r}},this.FetchListResult=class{constructor(e,t,s,i){this._parent=e,this.fetchParameters=t,this.data=s,this.metadata=i,this.fetchParameters=t,this.data=s,this.metadata=i}},this.FetchByOffsetParameters=class{constructor(e,t,s,i,a,r){this._parent=e,this.offset=t,this.size=s,this.sortCriteria=i,this.filterCriterion=a,this.attributes=r,this.offset=t,this.size=s,this.sortCriteria=i,this.filterCriterion=a,this.attributes=r}},this.FetchByOffsetResults=class{constructor(e,t,s,i){this._parent=e,this.fetchParameters=t,this.results=s,this.done=i,this.fetchParameters=t,this.results=s,this.done=i}},this.FetchByKeysResults=class{constructor(e,t,s){this._parent=e,this.fetchParameters=t,this.results=s,this.fetchParameters=t,this.results=s}},this.DataProviderMutationEventDetail=class{constructor(e,t,s,i){this._parent=e,this.add=t,this.remove=s,this.update=i,this.add=t,this.remove=s,this.update=i}},this.DataProviderRefreshEventDetail=class{constructor(e){this.disregardAfterKey=e,this.disregardAfterKey=e}},this.DataProviderOperationEventDetail=class{constructor(e,t,s,i,a,r){this._parent=e,this.keys=t,this.metadata=s,this.data=i,this.indexes=a,this.transient=r,this.keys=t,this.metadata=s,this.data=i,this.indexes=a,this.transient=r}},this.DataProviderAddOperationEventDetail=class{constructor(e,t,s,i,a,r,n){this._parent=e,this.keys=t,this.afterKeys=s,this.addBeforeKeys=i,this.metadata=a,this.data=r,this.indexes=n,this.keys=t,this.afterKeys=s,this.addBeforeKeys=i,this.metadata=a,this.data=r,this.indexes=n}},this.TaskQueue=class{constructor(){this.queue=[],this.isRunning=!1}enqueue(e){return new Promise((t,s)=>{this.queue.push({task:e,resolve:t,reject:s}),this.isRunning||this.dequeue()})}async dequeue(){if(0===this.queue.length)return void(this.isRunning=!1);this.isRunning=!0;const{task:e,resolve:t,reject:s}=this.queue.shift();try{t(await e())}catch(e){s(e)}finally{this.dequeue()}}},null==this.options&&(this.options={}),this.options.expanded||(this.options.expanded=new n.KeySetImpl([])),this._expandedObservable=new i.BehaviorSubject(this._getExpandedObservableValue(this.options.expanded,Promise.resolve())),this.dataProvider.addEventListener("mutate",this._handleUnderlyingMutation.bind(this)),this.dataProvider.addEventListener("refresh",this._handleUnderlyingRefresh.bind(this)),this._cache=[],this._mapClientIdToIteratorInfo=new Map,this._fetchQueue=[],this._taskQueue=new this.TaskQueue,this._notDoneKeyMap=new a,this._notDoneKeyMap.set(null,!0)}_getChildrenFromCacheByParentKey(e){return this._cache.filter(t=>t.metadata.parentKey===e)}sortedIndex(e,t){var s=0,i=e.length;if(null===t.index)return i;for(;s<i;){var a=s+i>>>1;null!==e[a].index&&e[a].index<t.index?s=a+1:i=a}return s}_processAddEvent(e){let t=[],s=0;if(e.keys.forEach(function(i){t.push({key:i,parentKey:e.parentKeys[s],beforeKey:e.addBeforeKeys?.[s],index:e.indexes?.[s],data:e.data?.[s],metadata:e.metadata?.[s]}),s++}),this._cacheSortCriteria){let e=0;for(;t.length!==e;){e=t.length;for(let e=t.length-1;e>=0;e--){const s=t[e],i=s.key,a=s.parentKey;if((null===a||this._isExpanded(a)&&this._containsKey(a))&&!this._containsKey(i)&&(!this._currentFilterCriteria||this._currentFilterCriteria&&this._currentFilterCriteria.filter(s.data))){const i=this._getChildrenFromCacheByParentKey(a),n=r.SortUtils.getNaturalSortCriteriaComparator(this._cacheSortCriteria);let h=!1;for(let a=0;a<i.length;a++)if(n(s.data,i[a].data)<0){this._spliceAddToCache(s,this._getItemIndexByKey(i[a].metadata.key)),h=!0,t.splice(e,1);break}if(!h&&this._isKeyDone(a))if(null===a)this._pushAddToCache(s),t.splice(e,1);else{const i=this._getItemIndexByKey(a)+this._getLocalDescendentCount(a)+1;this._spliceAddToCache(s,i),t.splice(e,1)}}}}}else if(e?.addBeforeKeys?.length>0){let e=0;for(;t.length!==e;){e=t.length;for(let e=t.length-1;e>=0;e--){const s=t[e],i=s.key,a=s.parentKey,r=this._getItemIndexByKey(a);if((null===a||this._isExpanded(a)&&-1!==r)&&!this._containsKey(i)&&(!this._currentFilterCriteria||this._currentFilterCriteria&&this._currentFilterCriteria.filter(s.data))){const i=s.beforeKey;if(null!=i){const a=this._getItemIndexByKey(i);-1!==a&&(this._spliceAddToCache(s,a),t.splice(e,1))}else if(this._isKeyDone(a))if(null===a)this._pushAddToCache(s),t.splice(e,1);else{const i=r+this._getLocalDescendentCount(a)+1;this._spliceAddToCache(s,i),t.splice(e,1)}}}}}else if(e?.indexes?.length>0){let e=Array.from(t.reduce((e,t)=>{const s=t.parentKey;if(e.has(s)){let i=e.get(s);i.splice(this.sortedIndex(i,t),0,t)}else e.set(s,[t]);return e},new Map).entries()),s=0;for(;e.length!==s;){s=e.length;for(let t=0;t<e.length;){const s=e[t],i=s[0],a=this._getItemIndexByKey(i);if(null===i||this._isExpanded(i)&&-1!==a){const r=this._getChildrenFromCacheByParentKey(i);s[1].forEach(e=>{const t=e.key;if(!this._containsKey(t)&&(!this._currentFilterCriteria||this._currentFilterCriteria&&this._currentFilterCriteria.filter(e.data))){const t=e.index;let s;if(0===t)s=null===i?this._unshiftAddToCache(e):this._spliceAddToCache(e,a+1),r.unshift(s);else if(null===t||t>r.length){if(this._isKeyDone(i)){if(null===i)s=this._pushAddToCache(e);else{const t=a+this._getLocalDescendentCount(i)+1;s=this._spliceAddToCache(e,t)}r.push(s)}}else{const i=this._getItemIndexByKey(r[t-1].metadata.key)+this._getLocalDescendentCount(r[t-1].metadata.key)+1;s=this._spliceAddToCache(e,i),r.splice(t,0,s)}}}),e.splice(t,1)}else t++}}}else t.forEach(e=>{const t=e.parentKey,s=e.key;if((null===t||this._isExpanded(t)&&this._containsKey(t))&&!this._containsKey(s)&&(!this._currentFilterCriteria||this._currentFilterCriteria&&this._currentFilterCriteria.filter(e.data)&&this._isKeyDone(t)))if(null===t)this._pushAddToCache(e);else{const s=this._getItemIndexByKey(t)+this._getLocalDescendentCount(t)+1;this._spliceAddToCache(e,s)}})}_incrementIndexFromParent(e,t){const s=this._getLastItemIndex();for(let i=e;i<=s;i++){let e=this._getItem(i);if(null!=e){const s=e.metadata.treeDepth;if(s===t)e.metadata.indexFromParent+=1;else if(s<t)return}}}_decrementIndexFromParent(e,t){const s=this._getLastItemIndex();for(let i=e;i<=s;i++){let e=this._getItem(i);if(null!=e){const s=e.metadata.treeDepth;if(s===t)e.metadata.indexFromParent-=1;else if(s<t)return}}}_handleUnderlyingMutation(e){let t=null,s=null,i=null;const a=e.detail.add;if(a&&a.data&&a.data.length){const e=[],s=[],i=[],r=[],n=[],h=new Set,d=new Set;this._processAddEvent(a),a.keys.forEach(t=>{const{index:a,item:h}=this._getItemAndIndexByKey(t);null!=h&&(s.push(h.data),e.push(h.metadata),i.push(a),n.push(h.metadata.parentKey),d.add(t),r.push(this._getKeyByIndex(a+1)))}),d.size>0&&(t=new this.DataProviderAddOperationEventDetail(this,d,h,r,e,s,i))}const n=e.detail.remove;if(n&&n.data&&n.data.length){const e=n.metadata.map(e=>e.key),t=[],i=[],a=[],r=new Set;e.forEach((e,s)=>{const n=this._getItemIndexByKey(e);if(-1!=n){const s=this._getLocalDescendentCount(e)+1;this._decrementIndexFromParent(n,this._cache[n].metadata.treeDepth);this._cache.splice(n,s).forEach((e,s)=>{r.add(e.metadata.key),t.push(e.metadata),i.push(e.data),a.push(n+s),this._decrementIteratorOffset(n),this._notDoneKeyMap.delete(e.metadata.key)})}}),r.size>0&&(s=new this.DataProviderOperationEventDetail(this,r,t,i,a))}const h=e.detail.update;if(h&&h.data&&h.data.length){const e=[],t=[],s=[],a=new Set;h.metadata.forEach((i,r)=>{const n=this._getItemByKey(i.key);if(null!=n){const d=this._getItemIndexByKey(i.key),o=h.data[r],c=new this.FlattenedTreeItemMetadata(this,h.metadata[r].key,n.metadata.parentKey,n.metadata.indexFromParent,n.metadata.treeDepth,null===this.getChildDataProvider(h.metadata[r].key));this._cache.splice(d,1,new this.Item(this,c,o)),a.add(h.metadata[r].key),e.push(c),t.push(o),s.push(d)}}),a.size>0&&(i=new this.DataProviderOperationEventDetail(this,a,e,t,s))}if(t||s||i){const e=new this.DataProviderMutationEventDetail(this,t,s,i);this.dispatchEvent(new r.DataProviderMutationEvent(e))}}_handleUnderlyingRefresh(e){if(e?.detail?.keys){const t=e.detail.keys;for(let e=0;e<this._cache.length;e++){const s=this._cache[e];if(t.has(s.metadata.key)){this._notDoneKeyMap.set(s.metadata.key,!0),this._markParentsAsNotDone(s);const e=this._getItemIndexByKey(s.metadata.key),t=this._getKeyByIndex(e-1),i=null!=t?new this.DataProviderRefreshEventDetail(t):void 0,a=new r.DataProviderRefreshEvent(i);this._cache.splice(e,this._cache.length).forEach(t=>{this._decrementIteratorOffset(e-1),this._notDoneKeyMap.delete(t.metadata.key)}),this.dispatchEvent(a);break}}}else this._fetchSize=null,this._clearCaches(),this.dispatchEvent(new r.DataProviderRefreshEvent)}_markParentsAsNotDone(e){const t=e.metadata.parentKey;this._notDoneKeyMap.set(t,!0),null!==t&&this._markParentsAsNotDone(this._getItemByKey(t))}_getExpandedObservableValue(e,t){return{value:e,completionPromise:t}}getChildDataProvider(e){return this.dataProvider.getChildDataProvider(e)}containsKeys(e){return this.dataProvider.containsKeys(e)}fetchByKeys(e){const s=new a,i=new t;return e.keys.forEach(e=>{const t=this._getItemByKey(e);t?s.set(e,t):i.add(e)}),0===i.size?Promise.resolve(new this.FetchByKeysResults(this,e,s)):this.dataProvider.fetchByKeys({...e,keys:i}).then(t=>(t.results.forEach((e,t)=>{s.set(t,e)}),new this.FetchByKeysResults(this,{...t.fetchParameters,keys:e.keys},s)))}async fetchByOffset(e){return await this._taskQueue.enqueue(async()=>this._fetchByOffset(e))}fetchFirst(e){const t=async()=>await this._taskQueue.enqueue(async()=>{this._fetchSize=null!=e?e.size:-1,this._isSameCriteria(e?.sortCriteria,e?.filterCriterion)||this._clearCaches(),this._currentSortCriteria=e?.sortCriteria,this._currentFilterCriteria=e?.filterCriterion;const t=this._mapClientIdToIteratorInfo.get(s._clientId),i=Object.assign({},e);return i.offset=t,i.size=this._fetchSize,this._fetchByOffset(i).then(e=>{const i=e.results,a=i.map(e=>e.data),r=i.map(e=>e.metadata),n=0===a.length,h=Object.assign({},e.fetchParameters);return delete h.offset,this._mapClientIdToIteratorInfo.set(s._clientId,t+r.length),n?new this.AsyncIteratorReturnResult(this,new this.FetchListResult(this,h,a,r)):new this.AsyncIteratorYieldResult(this,new this.FetchListResult(this,h,a,r))})}),s=new this.AsyncIterable(this,new this.AsyncIterator(this,t,e));return s}getCapability(e){if("fetchByOffset"===e){return{caching:"visitedByCurrentIterator",implementation:"randomAccess"}}if("fetchFirst"===e){return{caching:"visitedByCurrentIterator",iterationSpeed:"delayed"}}return this.dataProvider.getCapability(e)}getTotalSize(){return Promise.resolve(-1)}isEmpty(){return this.dataProvider.isEmpty()}_fetchByOffset(e){const t=null!=e?.size?e.size:-1;null==this._fetchSize&&(this._fetchSize=t);const s=null!=e?.offset&&e.offset>0?e.offset:0,i=Object.assign({},e);if(i.size=t,i.offset=s,this._isSameCriteria(i.sortCriteria,i.filterCriterion)){if(this._currentSortCriteria=i.sortCriteria,this._currentFilterCriteria=i.filterCriterion,this._doesCacheSatisfyParameters(i))return Promise.resolve(this._getFetchByOffsetResultsFromCache(i))}else this._clearCaches(),this._currentSortCriteria=i.sortCriteria,this._currentFilterCriteria=i.filterCriterion;return this._fetchByOffsetFromDataProvider(i)}_isSameCriteria(t,s){return(null==this._cacheSortCriteria&&null==t||e.Object.compareValues(this._currentSortCriteria,t))&&(null==this._currentFilterCriteria&&null==s||e.Object.__innerEquals(this._currentFilterCriteria,s))}_doesCacheSatisfyParameters(e,t=!1,s=0){return-1===e.size?this._isDone():t?s>=e.size:this._cache.length>=e.offset+e.size}_getFetchByOffsetResultsFromCache(e){let t,s=this._isDone();return-1===e.size?t=this._cache.slice(e.offset,void 0):(t=this._cache.slice(e.offset,e.offset+e.size),s=s&&e.offset+e.size>=this._cache.length),e.sortCriteria=this._cacheSortCriteria,e.filterCriterion=this._cacheFilterCriteria,new this.FetchByOffsetResults(this,e,t,s)}_clearCaches(){this._cache=[],this._cacheSortCriteria=null,this._cacheFilterCriteria=null,this._cacheInstantiated=!1,this._notDoneKeyMap.clear(),this._notDoneKeyMap.set(null,!0)}_isDone(){return 0===this._notDoneKeyMap.size}_isCacheEmpty(){return 0===this._cache.length}_getFetchDetails(e=0,t=null,s=0,i=this._cache.length,a=!1,r=0){return{parentKey:t,level:s,levelOffset:e,cacheOffset:i,isExpand:a,ancestorsAddedCount:r}}async _fetchByOffsetFromDataProvider(e){let t=0;if(!this._isCacheEmpty()){const s=await this._fetchChildrenByOffsetFromAncestors(e,this._getLastItem());if(s.paramsSatisfied||this._isKeyDone(null))return this._getFetchByOffsetResultsFromCache(e);t=s.ancestor.metadata.indexFromParent+1}const s=this._getFetchDetails(t);return await this._fetchChildrenByOffsetFromDataProvider(this.dataProvider,e,s),this._getFetchByOffsetResultsFromCache(e)}async _fetchChildrenByOffsetFromAncestors(e,t,s=0){let i,a=!1;const r=t.metadata.key,n=t.metadata.parentKey;if(!t.metadata.isLeaf&&this._isExpanded(r)&&!this._isKeyDone(r)){const n=this.getChildDataProvider(r),h=this._getFetchDetails(s,r,t.metadata.treeDepth+1);if(i=await this._fetchChildrenByOffsetFromDataProvider(n,e,h),a=i.paramsSatisfied,a)return{paramsSatisfied:a,ancestor:t}}if(null===n)return{paramsSatisfied:a,ancestor:t};const h=this._getItemByKey(n),d=t.metadata.indexFromParent+1;return i=await this._fetchChildrenByOffsetFromAncestors(e,h,d),a=i.paramsSatisfied,{paramsSatisfied:a,ancestor:i.ancestor}}async _fetchChildrenByOffsetFromDataProvider(e,t,s){const{parentKey:i,level:a,levelOffset:r,cacheOffset:n,isExpand:h,ancestorsAddedCount:d}=s,o=this._getModifiedFetchParameters(t,s),c=await e.fetchByOffset(o),l=c.results;this._cacheInstantiated||(this._cacheSortCriteria=c.fetchParameters.sortCriteria,this._cacheFilterCriteria=c.fetchParameters.filterCriterion,this._cacheInstantiated=!0);let f=!1,u=0,_=!0;for(let e=0;e<l.length;e++){const s=l[e],o=s.metadata.key,c=this.getChildDataProvider(o),y=null==c,m=this._isExpanded(o),p=!(!!y||"yes"===c.isEmpty())&&m;p&&this._notDoneKeyMap.set(o,!0);const I=this._updateItemMetadata(s,i,a,r+e,y);if(this._cache.splice(n+u,0,I),u++,_=e===l.length-1,f=this._doesCacheSatisfyParameters(t,h,u+d),f)break;if(p){let e=this._getFetchDetails(0,o,a+1,n+u,h,u),s=await this._fetchChildrenByOffsetFromDataProvider(c,t,e);if(u+=s.descendentsAddedCount,f=s.paramsSatisfied,f)break}}return _&&c.done&&this._notDoneKeyMap.delete(i),{paramsSatisfied:f,descendentsAddedCount:u}}_isKeyDone(e){return!this._notDoneKeyMap.has(e)}_isExpanded(e){return this.options.expanded?.has(e)}_getModifiedFetchParameters(e,t){let s,i=Object.assign({},e),a=t.levelOffset;return s=t.isExpand?e.size-t.ancestorsAddedCount:-1===e.size?-1:e.offset+e.size-this._cache.length,i.offset=a,i.size=s,i}setExpanded(e){const t=this._taskQueue.enqueue(async()=>{const t=this.createOptimizedKeySet(),s=this.createOptimizedKeySet();this._oldExpanded=this.options.expanded,this.options.expanded=e;const i=this._oldExpanded,a=this.options.expanded;if(a.isAddAll()||i.isAddAll()){if(!a.isAddAll()||!i.isAddAll())return this._clearCaches(),void this.dispatchEvent(new r.DataProviderRefreshEvent);{const e=a.deletedValues(),r=i.deletedValues();e.forEach(e=>{i.has(e)&&s.add(e)}),r.forEach(e=>{a.has(e)&&t.add(e)})}}else{const e=a.values(),r=i.values();e.forEach(e=>{i.has(e)||t.add(e)}),r.forEach(e=>{a.has(e)||s.add(e)})}const n=this._collapse(s),h=this._expand(t),d=new Promise(e=>{h.then(t=>{const s=t.operationAddEventDetail,i=t.disregardAfterItem,a=t.disregardAfterDescendentsAddedCount;if(null!=i){const e=i.metadata.key,t=this._getItemIndexByKey(e),s=this._cache.splice(t+a+1,this._cache.length);this._markParentsAsNotDone(i),s.forEach(e=>{this._notDoneKeyMap.delete(e.metadata.key)});for(let e=0;e<s.length;e++)this._decrementIteratorOffset(t+1)}if(s?.keys?.size>0||n?.keys?.size>0){const e=new this.DataProviderMutationEventDetail(this,s,n,null);this.dispatchEvent(new r.DataProviderMutationEvent(e))}if(null!=i){const e=new r.DataProviderRefreshEvent(new this.DataProviderRefreshEventDetail(i.metadata.key));this.dispatchEvent(e)}e()})});return await d});this.getExpandedObservable().next(this._getExpandedObservableValue(e,t))}getExpandedObservable(){return this._expandedObservable}_updateItemMetadata(e,t,s,i,a){return new this.Item(this,new this.FlattenedTreeItemMetadata(this,e.metadata.key,t,i,s,a),e.data)}_containsKey(t){return this._cache.some(s=>e.Object.compareValues(s.metadata.key,t))}_getItemByKey(t){return this._cache.find(s=>e.Object.compareValues(s.metadata.key,t))}_getItemIndexByKey(t){return this._cache.findIndex(s=>e.Object.compareValues(s.metadata.key,t))}_getItemAndIndexByKey(t){let s=-1,i=this._cache.find((i,a)=>(s=a,e.Object.compareValues(i.metadata.key,t)));return null==i&&(s=-1),{item:i,index:s}}_getPreviousSibling(e){return this._cache[this._getLastItemIndex()]}_getLastItem(){return this._cache[this._getLastItemIndex()]}_getItem(e){return this._cache[e]}_getLastItemIndex(){return this._cache.length-1}_getLocalDescendentCount(e){if(null===e)return this._cache.length;const t=this._getItemByKey(e);let s=0;if(null!=t){const i=this._getItemIndexByKey(e),a=t.metadata.treeDepth,r=this._getLastItemIndex();for(let e=i+1;e<=r;e++){if(!(this._getItem(e).metadata.treeDepth>a))return s;s+=1}}return s}_getInsertIndexFromParent(e,t){for(let s=t-1;s>=0;s--){const t=this._getItem(s),i=t.metadata.treeDepth;if(i===e)return t.metadata.indexFromParent+1;if(i<e)return 0}return 0}async _expand(e){const t=this._filterAndSortKeysByIndex(e);let s;const i=this.createOptimizedKeySet(),a=this.createOptimizedKeySet(),r=[],n=[],h=[],d=[];let o;for(let e=0;e<t.length;e++){const c=t[e],l=this._getItemIndexByKey(c),f=this.getChildDataProvider(c);if(null==f)continue;const u=this._getItem(l),_=l+1,y=new this.FetchByOffsetParameters(this,0,this._fetchSize,this._currentSortCriteria,this._currentFilterCriteria,null),m=this._getFetchDetails(0,c,u.metadata.treeDepth+1,_,!0);this._notDoneKeyMap.set(c,!0);let{descendentsAddedCount:p}=await this._fetchChildrenByOffsetFromDataProvider(f,y,m);if(!this._isKeyDone(c)){s=u,o=p;break}let I=c;this._cache.slice(_,_+p).forEach((e,t)=>{i.add(e.metadata.key),a.add(I),n.push(e.metadata),h.push(e.data),d.push(_+t),r.push(this._getKeyByIndex(_+t+1)),I=e.metadata.key,this._incrementIteratorOffset(_)})}return{operationAddEventDetail:i.size>0?new this.DataProviderAddOperationEventDetail(this,i,a,r,n,h,d):null,disregardAfterItem:s,disregardAfterDescendentsAddedCount:o}}_getKeyByIndex(e){return this._cache[e]?.metadata?.key?this._cache[e].metadata.key:null}_filterAndSortKeysByIndex(e){return[...e].reduce((e,t)=>{let s=this._getItemIndexByKey(t);return-1!=s&&e.push({key:t,index:s}),e},[]).sort((e,t)=>e.index-t.index).map(e=>e.key)}_collapse(e){const t=[],s=[],i=[],a=this.createOptimizedKeySet();return e.forEach(e=>{const r=this._getLocalDescendentCount(e);if(this._notDoneKeyMap.delete(e),r>0){const n=this._getItemIndexByKey(e);this._cache.splice(n+1,r).forEach((e,r)=>{this._notDoneKeyMap.delete(e.metadata.key),a.add(e.metadata.key),t.push(e.metadata),s.push(e.data),i.push(n+r+1),this._decrementIteratorOffset(n+1)})}}),new this.DataProviderOperationEventDetail(this,a,t,s,i,!0)}_decrementIteratorOffset(e){this._mapClientIdToIteratorInfo.forEach((t,s)=>{e<t&&this._mapClientIdToIteratorInfo.set(s,t-1)})}_incrementIteratorOffset(e){this._mapClientIdToIteratorInfo.forEach((t,s)=>{e<t&&this._mapClientIdToIteratorInfo.set(s,t+1)})}createOptimizedKeySet(e){return this.dataProvider.createOptimizedKeySet?this.dataProvider.createOptimizedKeySet(e):new t(e)}createOptimizedKeyMap(e){if(this.dataProvider.createOptimizedKeyMap)return this.dataProvider.createOptimizedKeyMap(e);if(e){const t=new a;return e.forEach((e,s)=>{t.set(s,e)}),t}return new a}}return e._registerLegacyNamespaceProp("FlattenedTreeDataProviderView",h),s.EventTargetMixin.applyMixin(h),h});
//# sourceMappingURL=ojflattenedtreedataproviderview.js.map