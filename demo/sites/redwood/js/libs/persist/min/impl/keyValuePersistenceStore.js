/**
 * Copyright (c) 2017, Oracle and/or its affiliates.
 * All rights reserved.
 */

define(["../PersistenceStore","./storageUtils","./logger"],(function(e,t,r){"use strict";var n=function(t){e.call(this,t)};return(n.prototype=new e).Init=function(e){return this._version=e&&e.version||"0",Promise.resolve()},n.prototype.getItem=function(e){throw TypeError("failed in abstract function")},n.prototype.removeByKey=function(e){throw TypeError("failed in abstract function")},n.prototype.keys=function(){throw TypeError("failed in abstract function")},n.prototype.findByKey=function(e){return r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: findByKey() with key: "+e),this.getItem(e).then((function(e){return e?Promise.resolve(e.value):Promise.resolve()}))},n.prototype.find=function(e){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: find() with expression: "+JSON.stringify(e));var n=this,o=[],s=[];return e=e||{},this.keys().then((function(r){for(var i=[],l=0;l<r.length;l++){var u=r[l];u&&i.push(function(r){return n.getItem(r).then((function(n){n&&t.satisfy(e.selector,n)&&(n.key=r,s.push(n))}))}(u))}return Promise.all(i).then((function(){for(var r=t.sortRows(s,e.sort),i=0;i<r.length;i++)o.push(n._constructReturnObject(e.fields,r[i]));return Promise.resolve(o)}))}))},n.prototype.updateKey=function(e,t){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: updateKey() with currentKey: "+e+" and new key: "+t);var n=this;return this.getItem(e).then((function(e){return e?n._insert(t,e.metadata,e.value):Promise.reject("No existing key found to update")})).then((function(){return n.removeByKey(e)}))},n.prototype._constructReturnObject=function(e,r){return e?t.assembleObject(r,e):r.value},n.prototype._removeByKeyMapCallback=function(e){var t=this;return function(r){var n;return n=e?r[e]:r,t.removeByKey(n)}},n.prototype.delete=function(e){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: delete() with expression: "+JSON.stringify(e));var t=this;if(!e)return this.deleteAll();var n=e;return n.fields=["key"],t.find(n).then((function(e){if(e&&e.length){var r=e.map(t._removeByKeyMapCallback("key"),t);return Promise.all(r)}return Promise.resolve()}))},n.prototype.deleteAll=function(){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: deleteAll()");var e,t=this,n=[];return this.keys().then((function(r){for(e=0;e<r.length;e++)n.push(t.removeByKey(r[e]));return Promise.all(n)}))},n.prototype.upsert=function(e,t,n,o){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: upsert() for key: "+e);var s=this;return this.getItem(e).then((function(r){if(r&&o){var i=r.metadata.versionIdentifier;return i!==o?Promise.reject({status:409}):t.versionIdentifier!==i?s._insert(e,t,n):Promise.resolve()}return s._insert(e,t,n)}))},n.prototype.upsertAll=function(e){r.log("Offline Persistence Toolkit keyValuePersistenceStore called by subclass: upsertAll()");for(var t=[],n=0;n<e.length;n++){var o=e[n];t.push(this.upsert(o.key,o.metadata,o.value,o.expectedVersionIndentifier))}return Promise.all(t)},n}));